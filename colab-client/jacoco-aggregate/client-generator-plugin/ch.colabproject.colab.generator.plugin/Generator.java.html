<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Generator.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-client</a> &gt; <a href="../index.html" class="el_bundle">client-generator-plugin</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.generator.plugin</a> &gt; <span class="el_source">Generator.java</span></div><h1>Generator.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.generator.plugin;

import ch.colabproject.colab.generator.model.annotations.JsonbMapperProvider;
import ch.colabproject.colab.generator.model.interfaces.WithJsonDiscriminator;
import ch.colabproject.colab.generator.plugin.rest.RestController;
import java.io.BufferedWriter;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Type;
import java.nio.file.Files;
import java.util.AbstractMap.SimpleEntry;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.stream.Collectors;
import javax.json.bind.Jsonb;
import javax.ws.rs.ApplicationPath;
import javax.ws.rs.Path;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugin.logging.Log;
import org.reflections.Reflections;

/**
 *
 * @author maxence
 */
public class Generator {

    /**
     * Reflections one-stop-shop object.
     */
    private final Reflections reflections;

    /**
     * All rest controller found.
     */
    private Set&lt;RestController&gt; restControllers;

    /**
     * Maven process logger
     */
    private final Log log;

    /**
     * Client will be generated in this package
     */
    private final String packageName;

    /**
     * Generated client name
     */
    private final String clientName;

    /**
     * Main REST application path
     */
<span class="nc" id="L67">    private String applicationPath = null;</span>

    /**
     * Initialize the client generator.
     *
     * @param restPackages packages to analyze
     * @param packageName  package in which generate the client
     * @param clientName   client class name
     * @param log          maven logger
     */
    public Generator(String[] restPackages,
        String packageName, String clientName,
        Log log
<span class="nc" id="L80">    ) {</span>
<span class="nc" id="L81">        this.log = log;</span>
<span class="nc" id="L82">        this.packageName = packageName;</span>
<span class="nc" id="L83">        this.clientName = clientName;</span>

<span class="nc" id="L85">        List&lt;Object&gt; pkgs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L86">        pkgs.add(&quot;ch.colabproject.colab.generator.model&quot;);</span>
<span class="nc" id="L87">        pkgs.addAll(Arrays.asList(restPackages));</span>

<span class="nc" id="L89">        this.reflections = new Reflections(pkgs.toArray());</span>
<span class="nc" id="L90">    }</span>

    /**
     *
     * Initialize the client generator.
     *
     * @param pkgs packages to analyze
     */
    public Generator(String[] pkgs) {
<span class="nc" id="L99">        this(pkgs, null, null, null);</span>
<span class="nc" id="L100">    }</span>

    /**
     * Try to find a jsonb mapper from a {@link JsonbMapperProvider} implementation.
     *
     * @return jsbonb mapper
     */
    public Jsonb getJsonBMapper() {
<span class="nc" id="L108">        Set&lt;Class&lt;? extends JsonbMapperProvider&gt;&gt; mapperProviders</span>
<span class="nc" id="L109">            = reflections.getSubTypesOf(JsonbMapperProvider.class);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (!mapperProviders.isEmpty()) {</span>
<span class="nc" id="L111">            Class&lt;? extends JsonbMapperProvider&gt; provider = mapperProviders.iterator().next();</span>
            try {
<span class="nc" id="L113">                return provider.getConstructor().newInstance().getJsonbMapper();</span>
<span class="nc" id="L114">            } catch (NoSuchMethodException | SecurityException | InstantiationException</span>
                    | IllegalAccessException | IllegalArgumentException
                    | InvocationTargetException ex) {
<span class="nc bnc" id="L117" title="All 2 branches missed.">                if (log != null) {</span>
<span class="nc" id="L118">                    log.error(&quot;Fails to instantiate JsonbMapperProvider&quot;);</span>
                }
            }
        }

<span class="nc" id="L123">        return null;</span>
    }

    /**
     * Process all classes annotated with {@link Path}. Generate a {@link RestController} instance
     * for each class and store them in {@link #restControllers}
     */
    public void processPackages() {
<span class="nc" id="L131">        Set&lt;Class&lt;?&gt;&gt; appConfig = reflections.getTypesAnnotatedWith(ApplicationPath.class);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (!appConfig.isEmpty()) {</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">            if (appConfig.size() &gt; 1 &amp;&amp; log != null) {</span>
<span class="nc" id="L134">                log.warn(&quot;Several ApplicationPath found&quot;);</span>
            }
<span class="nc" id="L136">            Class&lt;?&gt; applicationConfig = appConfig.iterator().next();</span>
<span class="nc" id="L137">            ApplicationPath annotation = applicationConfig.getAnnotation(ApplicationPath.class);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (annotation != null) {</span>
<span class="nc" id="L139">                this.applicationPath = annotation.value();</span>
            }
        }

<span class="nc" id="L143">        Set&lt;Class&lt;?&gt;&gt; restClasses = reflections.getTypesAnnotatedWith(Path.class);</span>

<span class="nc" id="L145">        this.restControllers = restClasses.stream()</span>
<span class="nc" id="L146">            .map(klass -&gt; RestController.build(klass, applicationPath, log))</span>
<span class="nc" id="L147">            .collect(Collectors.toSet());</span>
        /* .map(p -&gt; p.generateJavaClient()) .innerClasses(Collectors.toList());
         */
<span class="nc" id="L150">    }</span>

    /**
     * One all classes have been processed with {@link #processPackages() }, this method will create
     * subdirectories that match the &lt;code&gt;packageName&lt;/code&gt;.Then the client will be generated in
     * the &lt;code&gt;clientName&lt;/code&gt;.java file.
     *
     * @param targetDir target directory
     * @param dryRun    if true, do not generate files but print output to console
     *
     * @throws org.apache.maven.plugin.MojoFailureException if generation fails
     */
    public void generateJavaClient(String targetDir, boolean dryRun) throws MojoFailureException {
<span class="nc" id="L163">        Map&lt;String, String&gt; imports = new HashMap&lt;&gt;();</span>
<span class="nc" id="L164">        imports.put(&quot;RestClient&quot;, &quot;ch.colabproject.colab.generator.plugin.rest.RestClient&quot;);</span>
<span class="nc" id="L165">        imports.put(&quot;Jsonb&quot;, &quot;javax.json.bind.Jsonb&quot;);</span>
<span class="nc" id="L166">        imports.put(&quot;GenericType&quot;, &quot;javax.ws.rs.core.GenericType&quot;);</span>
<span class="nc" id="L167">        imports.put(&quot;PathPattern&quot;, &quot;org.glassfish.jersey.uri.PathPattern&quot;);</span>
<span class="nc" id="L168">        imports.put(&quot;UriTemplate&quot;, &quot;org.glassfish.jersey.uri.UriTemplate&quot;);</span>
<span class="nc" id="L169">        imports.put(&quot;void&quot;, null); // null means no import statement</span>

<span class="nc" id="L171">        String innerClasses = this.restControllers.stream().map(controller -&gt; {</span>
<span class="nc" id="L172">            String javaCode = controller.generateJavaClient(imports, clientName);</span>
<span class="nc" id="L173">            return javaCode;</span>
<span class="nc" id="L174">        }).collect(Collectors.joining(System.lineSeparator()));</span>

<span class="nc" id="L176">        StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L178">        sb.append(&quot;package &quot;).append(packageName).append(&quot;;\n\n&quot;)</span>
<span class="nc" id="L179">            .append(</span>
<span class="nc" id="L180">                imports.values().stream()</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                    .filter(pkg -&gt; pkg != null)</span>
<span class="nc" id="L182">                    .sorted()</span>
<span class="nc" id="L183">                    .map(pkg -&gt; &quot;import &quot; + pkg + &quot;;&quot;)</span>
<span class="nc" id="L184">                    .collect(Collectors.joining(System.lineSeparator()))</span>
            )
<span class="nc" id="L186">            .append(&quot;\n&quot;</span>
                + &quot;/**\n&quot;
                + &quot; * The &quot;)
<span class="nc" id="L189">            .append(clientName)</span>
<span class="nc" id="L190">            .append(&quot; REST client&quot;</span>
                + &quot; */\n&quot;
                + &quot;@SuppressWarnings(\&quot;PMD.FieldDeclarationsShouldBeAtStartOfClass\&quot;)\n&quot;
                + &quot;public class &quot;)
<span class="nc" id="L194">            .append(clientName)</span>
<span class="nc" id="L195">            .append(&quot; extends RestClient {&quot;</span>
                + &quot;\n&quot;
                + &quot;\n&quot;
                + &quot;    /**\n&quot;
                + &quot;     * Get a REST client\n&quot;
                + &quot;     *\n&quot;
                + &quot;     * @param baseUri        base URI\n&quot;
                + &quot;     * @param cookieName     session cookie name\n&quot;
                + &quot;     * @param jsonb          jsonb\n&quot;
                + &quot;     * @param clientFeatures addition http client feature\n&quot;
                + &quot;     */\n&quot;
                + &quot;    public &quot;)
<span class="nc" id="L207">            .append(clientName)</span>
<span class="nc" id="L208">            .append(&quot;(String baseUri, String cookieName, Jsonb jsonb, Object... clientFeatures) {\n&quot;</span>
                + &quot;        super(baseUri, cookieName, jsonb, clientFeatures);\n&quot;
                + &quot;    }&quot;)
<span class="nc" id="L211">            .append(innerClasses)</span>
<span class="nc" id="L212">            .append(&quot;}&quot;);</span>

<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (dryRun) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (log != null) {</span>
<span class="nc" id="L216">                log.debug(sb.toString());</span>
            }
        } else {
<span class="nc" id="L219">            String packagePath = targetDir + &quot;/&quot; + packageName.replaceAll(&quot;\\.&quot;, &quot;/&quot;);</span>
<span class="nc" id="L220">            writeFile(sb.toString(), packagePath, clientName + &quot;.java&quot;);</span>
        }
<span class="nc" id="L222">    }</span>

    /**
     * Get rest service description
     *
     * @return all rest resource
     */
    public Set&lt;RestController&gt; getRestControllers() {
<span class="nc" id="L230">        return restControllers;</span>
    }

    /**
     * Generate typescript client in targetDir
     *
     * @param targetDir generate TS module in this directory
     * @param dryRun    if true, do not generate any file but print output to console
     *
     * @throws org.apache.maven.plugin.MojoFailureException if generation fails
     */
    public void generateTypescriptClient(String targetDir, boolean dryRun)
        throws MojoFailureException {
<span class="nc" id="L243">        Map&lt;String, Type&gt; extraTypes = new HashMap&lt;&gt;();</span>
<span class="nc" id="L244">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L245">        sb.append(this.getTsClientTemplate());</span>
<span class="nc" id="L246">        extraTypes.put(&quot;WithJsonDiscriminator&quot;, WithJsonDiscriminator.class);</span>

<span class="nc" id="L248">        String modules = this.restControllers.stream().map(controller</span>
<span class="nc" id="L249">            -&gt; controller.generateTypescriptClient(extraTypes)</span>
<span class="nc" id="L250">        ).collect(Collectors.joining(System.lineSeparator()));</span>

        // TS interface name =&gt; list of @class values
<span class="nc" id="L253">        Map&lt;String, List&lt;String&gt;&gt; inheritance = new HashMap&lt;&gt;();</span>

<span class="nc" id="L255">        List&lt;Entry&lt;String, Type&gt;&gt; queue = new ArrayList&lt;&gt;(extraTypes.entrySet());</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">        while (!queue.isEmpty()) {</span>
<span class="nc" id="L257">            Map&lt;String, Type&gt; snowballedTypes = new HashMap&lt;&gt;();</span>

<span class="nc" id="L259">            Entry&lt;String, Type&gt; entry = queue.remove(0);</span>

<span class="nc" id="L261">            String tsInterface = TypeScriptHelper.generateInterface(</span>
<span class="nc" id="L262">                entry.getValue(),</span>
                snowballedTypes,
                inheritance,
                reflections
            );
<span class="nc" id="L267">            sb.append(tsInterface);</span>

<span class="nc" id="L269">            snowballedTypes.forEach((name, type) -&gt; {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                if (!extraTypes.containsKey(name)) {</span>
<span class="nc" id="L271">                    extraTypes.put(name, type);</span>
<span class="nc" id="L272">                    queue.add(0, new SimpleEntry&lt;String, Type&gt;(name, type));</span>
                }
<span class="nc" id="L274">            });</span>
<span class="nc" id="L275">        }</span>

<span class="nc" id="L277">        sb.append(&quot;/**&quot;</span>
            + &quot; * Some orthopedic tools&quot;
            + &quot; */&quot;
            + &quot;interface TypeMap {\n  &quot;)
<span class="nc" id="L281">            .append(</span>
<span class="nc" id="L282">                inheritance.keySet().stream().map((key)</span>
<span class="nc" id="L283">                    -&gt; key + &quot;: &quot; + key + &quot;;&quot;)</span>
<span class="nc" id="L284">                    .collect(Collectors.joining(&quot;\n  &quot;))</span>
            )
<span class="nc" id="L286">            .append(&quot;\n}\n\n&quot;)</span>
<span class="nc" id="L287">            .append(&quot;const inheritance : {[key: string]: string[]} = {\n&quot;)</span>
<span class="nc" id="L288">            .append(</span>
<span class="nc" id="L289">                inheritance.entrySet().stream().map((entry)</span>
<span class="nc" id="L290">                    -&gt; entry.getKey() + &quot;: [&quot; + entry.getValue().stream()</span>
<span class="nc" id="L291">                .map(v -&gt; &quot;'&quot; + v + &quot;'&quot;)</span>
<span class="nc" id="L292">                .collect(Collectors.joining(&quot;, &quot;)) + &quot;]&quot;</span>
<span class="nc" id="L293">                ).collect(Collectors.joining(&quot;,\n  &quot;)))</span>
<span class="nc" id="L294">            .append(&quot;\n}\n\n&quot;)</span>
<span class="nc" id="L295">            .append(&quot;export const entityIs = &lt;T extends keyof TypeMap&gt;(entity: unknown, klass: T)\n&quot;</span>
                + &quot;    : entity is TypeMap[T] =&gt; {\n&quot;
                + &quot;\n&quot;
                + &quot;    if (typeof entity === 'object' &amp;&amp; entity != null) {\n&quot;
                + &quot;        if (\&quot;@class\&quot; in entity) {\n&quot;
                + &quot;            const dis = entity[\&quot;@class\&quot;];\n&quot;
                + &quot;            if (typeof dis === 'string') {\n&quot;
                + &quot;                return inheritance[klass].includes(dis);\n&quot;
                + &quot;            }\n&quot;
                + &quot;        }\n&quot;
                + &quot;    }\n&quot;
                + &quot;    return false;\n&quot;
                + &quot;}&quot;)
<span class="nc" id="L308">            .append(&quot;\n\n\n/**\n&quot;</span>
<span class="nc" id="L309">                + &quot;* The &quot;).append(clientName).append(&quot; REST client\n&quot;</span>
            + &quot; */\n&quot;
<span class="nc" id="L311">            + &quot;export const &quot;).append(clientName)</span>
<span class="nc" id="L312">            .append(&quot; = function (baseUrl: string, errorHandler: (error: unknown) =&gt; void) {&quot;)</span>
<span class="nc" id="L313">            .append(&quot;\n    return {&quot;)</span>
<span class="nc" id="L314">            .append(modules)</span>
<span class="nc" id="L315">            .append(&quot;    }\n&quot;)</span>
<span class="nc" id="L316">            .append(&quot;}&quot;);</span>

<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (dryRun) {</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (log != null) {</span>
<span class="nc" id="L320">                log.debug(sb.toString());</span>
            }
        } else {
<span class="nc" id="L323">            String srcPath = targetDir + &quot;/src&quot;;</span>
<span class="nc" id="L324">            writeFile(sb.toString(), srcPath, clientName + &quot;.ts&quot;);</span>

<span class="nc" id="L326">            writeFile(&quot;export * from './dist/&quot; + clientName + &quot;';&quot;, targetDir, &quot;index.ts&quot;);</span>
<span class="nc" id="L327">            writeFile(generatePackageDotJson(), targetDir, &quot;package.json&quot;);</span>
<span class="nc" id="L328">            writeFile(generateTsconfigDotJson(), targetDir, &quot;tsconfig.json&quot;);</span>
        }
<span class="nc" id="L330">    }</span>

    /**
     * Write file to disk.
     *
     * @param content   file content
     * @param directory directory, will be created if missing
     * @param filename  filename
     */
    private void writeFile(String content, String directory, String filename)
        throws MojoFailureException {
        try {
<span class="nc" id="L342">            Files.createDirectories(java.nio.file.Path.of(directory));</span>

<span class="nc" id="L344">            try (BufferedWriter writer = Files.newBufferedWriter(</span>
<span class="nc" id="L345">                java.nio.file.Path.of(directory, filename))) {</span>
<span class="nc" id="L346">                writer.write(content);</span>
<span class="nc" id="L347">            } catch (IOException ex) {</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">                if (log != null) {</span>
<span class="nc" id="L349">                    throw new MojoFailureException(&quot;Failed to write '&quot;</span>
                        + filename + &quot;' in '&quot; + directory + &quot;'&quot;, ex);
                }
<span class="nc" id="L352">            }</span>

<span class="nc" id="L354">        } catch (IOException ex) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">            if (log != null) {</span>
<span class="nc" id="L356">                throw new MojoFailureException(&quot;Failed to create package directory &quot;</span>
                    + directory, ex);
            }
<span class="nc" id="L359">        }</span>
<span class="nc" id="L360">    }</span>

    /**
     * Convert Java className-like to dash-separated-lower-case version.
     *
     * @param name eg. MyAwesomeRestClient
     *
     * @return eg. my-awesome-rest-client
     */
    private String generateModuleName(String name) {
<span class="nc" id="L370">        return name</span>
<span class="nc" id="L371">            .trim()</span>
            // prefix all uppercase char preceded by something with an dash
<span class="nc" id="L373">            .replaceAll(&quot;(?&lt;!^)[A-Z](?!$)&quot;, &quot;-$0&quot;)</span>
<span class="nc" id="L374">            .toLowerCase();</span>
    }

    /**
     * get TS client tempalte
     *
     * @return intial content of the TS client
     */
    private String getTsClientTemplate() {
<span class="nc" id="L383">        String tsConfig = FileHelper.readFile(&quot;templates/client.ts&quot;);</span>
<span class="nc" id="L384">        return tsConfig.replaceAll(</span>
            &quot;\\{\\{MODULE_NAME\\}\\}&quot;,
<span class="nc" id="L386">            generateModuleName(clientName)</span>
        );
    }

    /**
     * generate package.json
     *
     * @return content of package.json
     */
    private String generatePackageDotJson() {
<span class="nc" id="L396">        String tsConfig = FileHelper.readFile(&quot;templates/package.json&quot;);</span>
<span class="nc" id="L397">        return tsConfig.replaceAll(</span>
            &quot;\\{\\{MODULE_NAME\\}\\}&quot;,
<span class="nc" id="L399">            generateModuleName(clientName)</span>
        );
    }

    /**
     * generate tsconfig.json
     *
     * @return content of package.json
     */
    private String generateTsconfigDotJson() {
<span class="nc" id="L409">        String tsConfig = FileHelper.readFile(&quot;templates/tsconfig.json&quot;);</span>
<span class="nc" id="L410">        return tsConfig.replaceAll(&quot;\\{\\{CLIENT_NAME\\}\\}&quot;, this.clientName);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>