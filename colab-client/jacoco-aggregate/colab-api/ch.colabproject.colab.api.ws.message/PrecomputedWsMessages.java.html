<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PrecomputedWsMessages.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-client</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.ws.message</a> &gt; <span class="el_source">PrecomputedWsMessages.java</span></div><h1>PrecomputedWsMessages.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.ws.message;

import ch.colabproject.colab.api.ws.channel.model.WebsocketChannel;
import ch.colabproject.colab.api.ws.utils.JsonEncoder;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.websocket.EncodeException;

/**
 * List of all WsMessages that should be sent through websockets. Messages are mapped with the
 * channel they should be sent through.
 *
 * @author maxence
 */
<span class="nc" id="L24">public class PrecomputedWsMessages implements Serializable {</span>

    private static final long serialVersionUID = 1L;

    /**
     * Each channel has a list of json-encoded messages
     */
    private Map&lt;WebsocketChannel, List&lt;String&gt;&gt; messages;

    /**
     * Get messages that should be sent.
     *
     * @return all messages, mapped by channel
     */
    public Map&lt;WebsocketChannel, List&lt;String&gt;&gt; getMessages() {
<span class="nc" id="L39">        return messages;</span>
    }

    /**
     * Set messages to send
     *
     * @param messages list of messages, map by their channels
     */
    public void setMessages(Map&lt;WebsocketChannel, List&lt;String&gt;&gt; messages) {
<span class="nc" id="L48">        this.messages = messages;</span>
<span class="nc" id="L49">    }</span>

    /**
     * Pre-compute all messages to send
     *
     * @param messages all messages
     *
     * @return the precomputed messages
     *
     * @throws EncodeException if something is not serializable.
     */
    public static PrecomputedWsMessages build(
        Map&lt;WebsocketChannel, List&lt;WsMessage&gt;&gt; messages
    ) throws EncodeException {
<span class="nc" id="L63">        PrecomputedWsMessages m = new PrecomputedWsMessages();</span>
<span class="nc" id="L64">        m.setMessages(new HashMap&lt;&gt;());</span>
<span class="nc" id="L65">        Map&lt;WebsocketChannel, List&lt;String&gt;&gt; encoded = m.getMessages();</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (messages != null) {</span>
            // TODO: is there a way to throw exception from lambda ?
<span class="nc bnc" id="L68" title="All 2 branches missed.">            for (var messageEntry : messages.entrySet()) {</span>
<span class="nc" id="L69">                var wsMessages = messageEntry.getValue();</span>
<span class="nc" id="L70">                var encodedMessages = new ArrayList&lt;String&gt;(wsMessages.size());</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">                for (var wsMessage : wsMessages) {</span>
<span class="nc" id="L72">                    encodedMessages.add(JsonEncoder.toJson(wsMessage));</span>
<span class="nc" id="L73">                }</span>
<span class="nc" id="L74">                encoded.put(messageEntry.getKey(), encodedMessages);</span>
<span class="nc" id="L75">            }</span>
        }
<span class="nc" id="L77">        return m;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L82">        return &quot;PrecomputedWsMessages{&quot; + &quot;messages=&quot; + messages + '}';</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>