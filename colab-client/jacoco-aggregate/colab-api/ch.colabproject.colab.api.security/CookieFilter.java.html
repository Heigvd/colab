<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CookieFilter.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-client</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.security</a> &gt; <span class="el_source">CookieFilter.java</span></div><h1>CookieFilter.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021-2023 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.security;

import ch.colabproject.colab.api.controller.RequestManager;
import ch.colabproject.colab.api.model.user.HttpSession;
import java.io.IOException;
import javax.annotation.Priority;
import javax.inject.Inject;
import javax.ws.rs.container.ContainerRequestContext;
import javax.ws.rs.container.ContainerRequestFilter;
import javax.ws.rs.container.ContainerResponseContext;
import javax.ws.rs.container.ContainerResponseFilter;
import javax.ws.rs.container.PreMatching;
import javax.ws.rs.core.Cookie;
import javax.ws.rs.core.HttpHeaders;
import javax.ws.rs.core.NewCookie;
import javax.ws.rs.ext.Provider;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Intercept all request to the API. Make sure COLAB_SESSION_ID exists
 * &lt;p&gt;
 * With a priority of 1, this {@link PreMatching @PreMatching} filter is the very first to be
 * executed
 *
 * @author maxence
 */
@Provider
@Priority(1)
@PreMatching
<span class="nc" id="L38">public class CookieFilter implements ContainerRequestFilter, ContainerResponseFilter {</span>

    /** Default max-age to one week [s] */
    private static final int COOKIE_MAX_AGE = 3600 * 24 * 7;

    /**
     * Logger
     */
<span class="nc" id="L46">    private static final Logger logger = LoggerFactory.getLogger(CookieFilter.class);</span>

    /**
     * Cluster-wide session cache.
     */
    @Inject
    private SessionManager sessionManager;

    /**
     * Request related logic
     */
    @Inject
    private RequestManager requestManager;

    /**
     * Name of the cookie
     */
    private static final String COOKIE_NAME = &quot;COLAB_SESSION_ID&quot;;

    /**
     * To parse cookie values
     */
    private static class ParsedCookie {

        /**
         * Http Session id
         */
<span class="nc" id="L73">        private Long id = null;</span>

        /**
         * Http session secret
         */
<span class="nc" id="L78">        private String secret = null;</span>

        /**
         * Parse the cookie value
         *
         * @param value cookie value to parse
         */
<span class="nc" id="L85">        public ParsedCookie(String value) {</span>
<span class="nc" id="L86">            logger.trace(&quot;Parse cookie value&quot;);</span>

            // The cookie: uid=1234:v=&lt;SECRET&gt;
<span class="nc" id="L89">            String[] split = value.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (split.length == 2) {</span>
                try {
<span class="nc bnc" id="L92" title="All 4 branches missed.">                    if (split[0].length() &gt;= 5 &amp;&amp; split[1].length() &gt;= 3) {</span>
<span class="nc" id="L93">                        this.id = Long.parseLong(split[0].substring(4), 10);</span>
<span class="nc" id="L94">                        this.secret = split[1].substring(2);</span>
                    } else {
<span class="nc" id="L96">                        logger.error(&quot;Invalid cookie: struct not match&quot;);</span>
                    }
<span class="nc" id="L98">                } catch (NumberFormatException ex) {</span>
<span class="nc" id="L99">                    logger.error(&quot;Invalid cookie: v=&lt;NOT_A_NUBER&gt;;...&quot;);</span>
<span class="nc" id="L100">                }</span>
            }
<span class="nc" id="L102">        }</span>
    }

    /**
     * Intercept request and make sure a httpSession is bound to the request
     *
     * @param requestContext request context
     *
     * @throws IOException if an I/O exception occurs.
     */
    @Override
    public void filter(ContainerRequestContext requestContext) throws IOException {
<span class="nc" id="L114">        Cookie cookie = requestContext.getCookies().get(COOKIE_NAME);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (cookie != null) {</span>
<span class="nc" id="L116">            String cookieValue = cookie.getValue();</span>
<span class="nc" id="L117">            logger.trace(&quot;Request received with session id {}&quot;, cookieValue);</span>

<span class="nc" id="L119">            ParsedCookie parsedCookie = new ParsedCookie(cookieValue);</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">            if (parsedCookie.id != null &amp;&amp; parsedCookie.secret != null) {</span>
<span class="nc" id="L121">                HttpSession httpSession = sessionManager.getAndValidate(parsedCookie.id,</span>
                    parsedCookie.secret);
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (httpSession != null) {</span>
<span class="nc" id="L124">                    requestManager.setHttpSessionId(httpSession.getId());</span>
<span class="nc" id="L125">                    return;</span>
                }
<span class="nc" id="L127">            } else {</span>
<span class="nc" id="L128">                logger.debug(&quot;Invalid cookie: reject&quot;);</span>
            }
<span class="nc" id="L130">            requestManager.setHttpSessionId(null);</span>
        }
<span class="nc" id="L132">    }</span>

    /**
     * Intercept response, save httpSession in sessions cache and make sure set-cookie header is set
     *
     * @param requestContext  the request context
     * @param responseContext the response context
     *
     * @throws IOException if an I/O exception occurs.
     */
    @Override
    public void filter(ContainerRequestContext requestContext,
        ContainerResponseContext responseContext) throws IOException {
<span class="nc" id="L145">        HttpSession session = requestManager.getHttpSession();</span>
<span class="nc" id="L146">        Cookie cookie = requestContext.getCookies().get(COOKIE_NAME);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (session != null) {</span>
<span class="nc" id="L148">            String cookieValue = null;</span>

<span class="nc bnc" id="L150" title="All 4 branches missed.">            if (cookie != null &amp;&amp; !StringUtils.isEmpty(cookie.getValue())) {</span>
<span class="nc" id="L151">                cookieValue = cookie.getValue();</span>
<span class="nc" id="L152">                ParsedCookie parsedCookie = new ParsedCookie(cookieValue);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                if (!parsedCookie.id.equals(session.getId())) {</span>
<span class="nc" id="L154">                    logger.trace(&quot;New httpSession detected&quot;);</span>
                    // session changed during the request =&gt; clear cookieValue to force to generate
                    // a full new cookie
<span class="nc" id="L157">                    cookieValue = null;</span>
                }
            }

<span class="nc bnc" id="L161" title="All 2 branches missed.">            if (cookieValue == null) {</span>
<span class="nc" id="L162">                logger.trace(&quot;CookieValue not set: build from rawSecret&quot;);</span>
                // CookieValue not set -&gt; build from
<span class="nc bnc" id="L164" title="All 2 branches missed.">                if (StringUtils.isBlank(session.getRawSessionSecret())) {</span>
                    // at login, new httpSession is created (SessionManager.createHttpSession)
                    // the raw secret must be available here to be sent to client
<span class="nc" id="L167">                    logger.error(&quot;COOKIE VALUE IS NOT SET&quot;);</span>
                }
<span class="nc" id="L169">                cookieValue = &quot;uid=&quot; + session.getId() + &quot;:v=&quot; + session.getRawSessionSecret();</span>
            }

<span class="nc" id="L172">            NewCookie sessionCookie = new NewCookie(COOKIE_NAME, cookieValue,</span>
                &quot;/&quot;, null, null, COOKIE_MAX_AGE, true, true);

            // hack: SameSite not handled yet by jakarta rs library
            // inject SameSite=Lax by hand
<span class="nc" id="L177">            String theCookie = sessionCookie.toString() + &quot;;SameSite=Lax&quot;;</span>

<span class="nc" id="L179">            logger.trace(&quot;Request completed with session id {}&quot;, session.getId());</span>
<span class="nc" id="L180">            responseContext.getHeaders().add(HttpHeaders.SET_COOKIE, theCookie);</span>
<span class="nc" id="L181">        } else {</span>
            // not session =&gt; clear cookie if exists
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (cookie != null) {</span>
                // Clear cookie by setting no value and max-age=0
<span class="nc" id="L185">                NewCookie sessionCookie = new NewCookie(COOKIE_NAME, &quot;&quot;,</span>
                    &quot;/&quot;, null, null, 0, true, true);

<span class="nc" id="L188">                logger.trace(&quot;Request completed with session id {}&quot;, sessionCookie);</span>
<span class="nc" id="L189">                responseContext.getHeaders().add(HttpHeaders.SET_COOKIE, sessionCookie);</span>
            }
        }
<span class="nc" id="L192">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>