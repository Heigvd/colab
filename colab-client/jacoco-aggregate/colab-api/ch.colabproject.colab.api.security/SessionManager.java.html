<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SessionManager.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-client</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.security</a> &gt; <span class="el_source">SessionManager.java</span></div><h1>SessionManager.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.security;

import ch.colabproject.colab.api.Helper;
import ch.colabproject.colab.api.model.user.HttpSession;
import ch.colabproject.colab.api.controller.RequestManager;
import ch.colabproject.colab.api.model.user.Account;
import ch.colabproject.colab.api.model.user.InternalHashMethod;
import ch.colabproject.colab.api.model.user.LocalAccount;
import ch.colabproject.colab.api.model.user.User;
import ch.colabproject.colab.api.persistence.jpa.user.UserDao;
import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.cp.lock.FencedLock;
import com.hazelcast.flakeidgen.FlakeIdGenerator;
import com.hazelcast.map.IMap;
import java.nio.charset.StandardCharsets;
import java.security.NoSuchAlgorithmException;
import java.time.OffsetDateTime;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import javax.cache.Cache;
import javax.cache.processor.MutableEntry;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.ejb.TransactionAttribute;
import javax.ejb.TransactionAttributeType;
import javax.inject.Inject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Bean to manage HTTP sessions
 *
 * @author maxence
 */
@Stateless
@LocalBean
<span class="nc" id="L44">public class SessionManager {</span>

    /** logger */
<span class="nc" id="L47">    private static final Logger logger = LoggerFactory.getLogger(SessionManager.class);</span>

    /** hazelcast instance */
    @Inject
    private HazelcastInstance hzInstance;

    /** account DAO */
    @Inject
    private UserDao userDao;

    /** request manager */
    @Inject
    private RequestManager requestManager;

    /** cache of failed authentication */
    @Inject
    private Cache&lt;Long, AuthenticationFailure&gt; authenticationFailureCache;

    /**
     * get user activity date cache. Map user id with activity date
     */
    private IMap&lt;Long, OffsetDateTime&gt; getUserActivityCache() {
<span class="nc" id="L69">        return hzInstance.getMap(&quot;USER_ACTIVITY_CACHE&quot;);</span>
    }

    /**
     * get account activity date cache. Map account id with activity date
     */
    private IMap&lt;Long, OffsetDateTime&gt; getHttpSessionActivityCache() {
<span class="nc" id="L76">        return hzInstance.getMap(&quot;HTTP_SESSION_ACTIVITY_CACHE&quot;);</span>
    }

    /**
     * Get a persisted session.
     *
     * @param sessionId session id
     * @param secret    the session secret
     *
     * @return a session if it exists or null
     */
    public HttpSession getAndValidate(Long sessionId, String secret) {
<span class="nc" id="L88">        HttpSession httpSession = userDao.getHttpSessionById(sessionId);</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (httpSession != null) {</span>
            try {
                // hash the secret sent by the client
<span class="nc" id="L93">                byte[] hash = InternalHashMethod.SHA_512.hash(secret);</span>
<span class="nc" id="L94">                httpSession.getSessionSecret();</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                if (Helper.constantTimeArrayEquals(hash, httpSession.getSessionSecret())) {</span>
<span class="nc" id="L96">                    return httpSession;</span>
                } else {
<span class="nc" id="L98">                    logger.error(&quot;Cookie secret does not match&quot;);</span>
                }
<span class="nc" id="L100">            } catch (NoSuchAlgorithmException ex) {</span>
<span class="nc" id="L101">                logger.error(&quot;SHA_512 NOT FOUND, THIS IS NOT GOOD; PLEASE INVESTIGATE&quot;);</span>
<span class="nc" id="L102">            }</span>
        }
<span class="nc" id="L104">        return null;</span>
    }

    /**
     * Create and persiste a new HTTP Session bound.
     *
     * @param account   the account the session is bound to
     * @param userAgent client user-agent
     *
     * @return brand new persisted HTTPsession
     */
    public HttpSession createHttpSession(Account account, String userAgent) {
<span class="nc" id="L116">        logger.debug(&quot;Creater new HttpSession for {}&quot;, account);</span>
<span class="nc" id="L117">        FlakeIdGenerator idGenerator = hzInstance.getFlakeIdGenerator(&quot;HTTP_SESSION_ID_GENERATOR&quot;);</span>

<span class="nc" id="L119">        String rawSecret = Helper.generateHexSalt(64) + &quot;-&quot; + idGenerator.newId();</span>
        byte[] secret;

        try {
<span class="nc" id="L123">            secret = InternalHashMethod.SHA_512.hash(rawSecret);</span>
<span class="nc" id="L124">        } catch (NoSuchAlgorithmException ex) {</span>
<span class="nc" id="L125">            secret = rawSecret.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L126">            logger.error(&quot;SHA_512 NOT FOUND, THIS IS NOT GOOD; PLEASE INVESTIGATE&quot;);</span>
<span class="nc" id="L127">        }</span>

<span class="nc" id="L129">        HttpSession httpSession = new HttpSession();</span>

<span class="nc" id="L131">        httpSession.setRawSessionSecret(rawSecret);</span>
<span class="nc" id="L132">        httpSession.setSessionSecret(secret);</span>

<span class="nc" id="L134">        httpSession.setAccount(account);</span>
<span class="nc" id="L135">        account.getHttpSessions().add(httpSession);</span>
<span class="nc" id="L136">        httpSession.setLastSeen(OffsetDateTime.now());</span>

<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (userAgent != null) {</span>
<span class="nc" id="L139">            httpSession.setUserAgent(userAgent);</span>
        } else {
<span class="nc" id="L141">            httpSession.setUserAgent(&quot;&quot;);</span>
        }

<span class="nc" id="L144">        return userDao.persistHttpSession(httpSession);</span>
    }

    /**
     * Remove httpSession
     *
     * @param session the httpSession to delete
     */
    public void deleteHttpSession(HttpSession session) {
<span class="nc" id="L153">        Account account = session.getAccount();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (account != null) {</span>
<span class="nc" id="L155">            account.getHttpSessions().remove(session);</span>
        }
<span class="nc" id="L157">        userDao.deleteHttpSession(session);</span>
<span class="nc" id="L158">    }</span>

    /**
     * keep trace of failed authentication attempt
     *
     * @param account the local account for which authentication failed
     *
     * @return the number of failed attempts in a row
     */
    public Long authenticationFailure(LocalAccount account) {
<span class="nc" id="L168">        return this.authenticationFailureCache.invoke(account.getId(), (MutableEntry&lt;Long, AuthenticationFailure&gt; entry, Object... arguments) -&gt; {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (entry.exists()) {</span>
<span class="nc" id="L170">                AuthenticationFailure value = entry.getValue();</span>
<span class="nc" id="L171">                value.inc();</span>
<span class="nc" id="L172">                entry.setValue(value);</span>
<span class="nc" id="L173">                return entry.getValue().getCounter();</span>
            } else {
<span class="nc" id="L175">                entry.setValue(new AuthenticationFailure());</span>
<span class="nc" id="L176">                return 1l;</span>
            }
        });
    }

    /**
     * clear failed attempts for given account
     *
     * @param account the account to clear attempts for
     */
    public void resetAuthenticationAttemptHistory(LocalAccount account) {
<span class="nc" id="L187">        this.authenticationFailureCache.remove(account.getId());</span>
<span class="nc" id="L188">    }</span>

    /**
     * Get history of failed authentication attempts for an account
     *
     * @param account account
     *
     * @return authentication failure history or null
     */
    public AuthenticationFailure getAuthenticationAttempt(LocalAccount account) {
<span class="nc" id="L198">        return this.authenticationFailureCache.get(account.getId());</span>
    }

    /**
     * Touch activity date for currentAccount
     */
    public void touchUserActivityDate() {
<span class="nc" id="L205">        HttpSession httpSession = requestManager.getHttpSession();</span>
<span class="nc" id="L206">        User user = requestManager.getCurrentUser();</span>

<span class="nc" id="L208">        OffsetDateTime now = OffsetDateTime.now();</span>
<span class="nc" id="L209">        logger.trace(&quot;Touch Activity ({}, {}) =&gt; {}&quot;, httpSession, user, now);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (httpSession != null) {</span>
<span class="nc" id="L211">            getHttpSessionActivityCache().set(httpSession.getId(), now);</span>
        }
<span class="nc bnc" id="L213" title="All 4 branches missed.">        if (user != null &amp;&amp; user.getId() != null) {</span>
<span class="nc" id="L214">            user.setActivityDate(now);</span>
<span class="nc" id="L215">            getUserActivityCache().set(user.getId(), now);</span>
        }
<span class="nc" id="L217">    }</span>

    /**
     * Get effective activity date for account
     *
     * @param user the account
     *
     * @return effective activity date
     */
    public OffsetDateTime getActivityDate(User user) {
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (user != null) {</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (user.getId() != null) {</span>
<span class="nc" id="L229">                OffsetDateTime date = getUserActivityCache().get(user.getId());</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (date != null) {</span>
<span class="nc" id="L231">                    return date;</span>
                }
            }
<span class="nc" id="L234">            return user.getActivityDate();</span>
        }
<span class="nc" id="L236">        return null;</span>
    }

    /**
     * Write in-cache activity-date to database
     */
    @TransactionAttribute(TransactionAttributeType.REQUIRES_NEW)
    public void writeActivityDatesToDatabase() {
<span class="nc" id="L244">        logger.trace(&quot;Write Activity Date to DB&quot;);</span>
<span class="nc" id="L245">        requestManager.sudo(() -&gt; {</span>
            // prevent updating tracking data (updated by and at)
<span class="nc" id="L247">            requestManager.setDoNotTrackChange(true);</span>
<span class="nc" id="L248">            IMap&lt;Long, OffsetDateTime&gt; userActivityCache = getUserActivityCache();</span>
<span class="nc" id="L249">            Iterator&lt;Map.Entry&lt;Long, OffsetDateTime&gt;&gt; iterator = userActivityCache.iterator();</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">            while (iterator.hasNext()) {</span>
<span class="nc" id="L251">                Map.Entry&lt;Long, OffsetDateTime&gt; next = iterator.next();</span>
<span class="nc" id="L252">                iterator.remove();</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">                if (next != null) {</span>
<span class="nc" id="L254">                    Long userId = next.getKey();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                    if (userId != null) {</span>
<span class="nc" id="L256">                        User user = userDao.findUser(userId);</span>
<span class="nc" id="L257">                        OffsetDateTime date = next.getValue();</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                        if (user != null) {</span>
<span class="nc" id="L259">                            logger.trace(&quot;Update User LastSeenAt: {}&quot;, date);</span>
<span class="nc" id="L260">                            user.setLastSeenAt(date);</span>
                        }
                    }
                }
<span class="nc" id="L264">            }</span>

<span class="nc" id="L266">            IMap&lt;Long, OffsetDateTime&gt; sessionActivityCache = getHttpSessionActivityCache();</span>
<span class="nc" id="L267">            iterator = sessionActivityCache.iterator();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            while (iterator.hasNext()) {</span>
<span class="nc" id="L269">                Map.Entry&lt;Long, OffsetDateTime&gt; next = iterator.next();</span>
<span class="nc" id="L270">                iterator.remove();</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">                if (next != null) {</span>
<span class="nc" id="L272">                    Long id = next.getKey();</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                    if (id != null) {</span>
<span class="nc" id="L274">                        HttpSession session = userDao.getHttpSessionById(id);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                        if (session != null) {</span>
<span class="nc" id="L276">                            OffsetDateTime date = next.getValue();</span>
<span class="nc" id="L277">                            logger.trace(&quot;Update HTTP session LastSeen: {}&quot;, date);</span>
<span class="nc" id="L278">                            session.setLastSeen(date);</span>
                        }
                    }
                }
<span class="nc" id="L282">            }</span>

<span class="nc" id="L284">        });</span>
<span class="nc" id="L285">    }</span>

    /**
     * Clean database. Remove expired HttpSession.
     */
    @TransactionAttribute(TransactionAttributeType.REQUIRES_NEW)
    public void clearExpiredSessions() {
<span class="nc" id="L292">        logger.trace(&quot;Clear expired HTTP session&quot;);</span>
<span class="nc" id="L293">        requestManager.sudo(() -&gt; {</span>
<span class="nc" id="L294">            FencedLock lock = hzInstance.getCPSubsystem().getLock(&quot;CleanExpiredSession&quot;);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (lock.tryLock()) {</span>
                try {
<span class="nc" id="L297">                    logger.trace(&quot;Got the lock, let's clear&quot;);</span>
<span class="nc" id="L298">                    IMap&lt;Long, OffsetDateTime&gt; cache = getHttpSessionActivityCache();</span>
<span class="nc" id="L299">                    List&lt;HttpSession&gt; list = userDao.getExpiredHttpSessions();</span>
<span class="nc" id="L300">                    logger.trace(&quot;List of expired session: {}&quot;, list);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                    for (HttpSession session : list) {</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                        if (!cache.containsKey(session.getId())) {</span>
<span class="nc" id="L303">                            logger.trace(&quot;Delete the session {}&quot;, session);</span>
<span class="nc" id="L304">                            userDao.deleteHttpSession(session);</span>
                        } else {
<span class="nc" id="L306">                            logger.trace(&quot;Seems httpSesion jsut waked up: {}&quot;, session);</span>
                        }
<span class="nc" id="L308">                    }</span>
                } finally {
<span class="nc" id="L310">                    lock.unlock();</span>
<span class="nc" id="L311">                }</span>
            } else {
<span class="nc" id="L313">                logger.trace(&quot;Did not got the log&quot;);</span>
            }
<span class="nc" id="L315">        });</span>
<span class="nc" id="L316">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>