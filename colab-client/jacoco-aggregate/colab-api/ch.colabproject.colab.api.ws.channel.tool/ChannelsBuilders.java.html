<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ChannelsBuilders.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-client</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.ws.channel.tool</a> &gt; <span class="el_source">ChannelsBuilders.java</span></div><h1>ChannelsBuilders.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.ws.channel.tool;

import ch.colabproject.colab.api.model.card.AbstractCardType;
import ch.colabproject.colab.api.model.project.Project;
import ch.colabproject.colab.api.model.user.Account;
import ch.colabproject.colab.api.model.user.User;
import ch.colabproject.colab.api.persistence.jpa.card.CardTypeDao;
import ch.colabproject.colab.api.persistence.jpa.user.UserDao;
import ch.colabproject.colab.api.ws.channel.model.BlockChannel;
import ch.colabproject.colab.api.ws.channel.model.BroadcastChannel;
import ch.colabproject.colab.api.ws.channel.model.ProjectContentChannel;
import ch.colabproject.colab.api.ws.channel.model.UserChannel;
import ch.colabproject.colab.api.ws.channel.model.WebsocketChannel;
import java.util.HashSet;
import java.util.Set;
import java.util.stream.Collectors;

/**
 * Compute the channels needed to propagate alteration changes.
 *
 * @author sandra
 */
public final class ChannelsBuilders {

    /**
     * Private constructor prevents instantiation
     */
<span class="nc" id="L34">    private ChannelsBuilders() {</span>
<span class="nc" id="L35">        throw new UnsupportedOperationException(&quot;This is a utility class&quot;);</span>
    }

    /**
     * To determine the channels to use
     */
<span class="nc" id="L41">    public static abstract class ChannelsBuilder {</span>
        /**
         * Determine the channels to use
         *
         * @param userDao     the dao to fetch users
         * @param cardTypeDao the dao to fetch card type
         *
         * @return all channels to use for propagation
         */
        public Set&lt;WebsocketChannel&gt; computeChannels(UserDao userDao, CardTypeDao cardTypeDao) {
<span class="nc" id="L51">            return build(userDao, cardTypeDao);</span>
        }

        /**
         * Determine the channels to use (internal implementation)
         *
         * @param userDao     the dao to fetch users
         * @param cardTypeDao the dao to fetch card type
         *
         * @return all channels to use for propagation
         */
        abstract protected Set&lt;WebsocketChannel&gt; build(UserDao userDao, CardTypeDao cardTypeDao);
    }

    /**
     * When there is no channel
     */
<span class="nc" id="L68">    public static class EmptyChannelBuilder extends ChannelsBuilder {</span>
        @Override
        protected Set&lt;WebsocketChannel&gt; build(UserDao userDao, CardTypeDao cardTypeDao) {
<span class="nc" id="L71">            return Set.of();</span>
        }
    }

    /**
     * To build a block channel
     */
    public static class BlockChannelBuilder extends ChannelsBuilder {
        /** the id of the block */
        private final Long blockId;

        /**
         * Create a builder for a block channel
         *
         * @param blockId the id of the block
         */
<span class="nc" id="L87">        public BlockChannelBuilder(Long blockId) {</span>
<span class="nc" id="L88">            this.blockId = blockId;</span>
<span class="nc" id="L89">        }</span>

        @Override
        protected Set&lt;WebsocketChannel&gt; build(UserDao userDao, CardTypeDao cardTypeDao) {
<span class="nc" id="L93">            return Set.of(BlockChannel.build(blockId));</span>
        }
    }

    /**
     * To build a project content channel
     */
    public static class ProjectContentChannelBuilder extends ChannelsBuilder {
        /** the id of the project */
        private final Long projectId;

        /**
         * Create a builder for a project content channel
         *
         * @param project the project
         */
<span class="nc" id="L109">        public ProjectContentChannelBuilder(Project project) {</span>
<span class="nc" id="L110">            projectId = project.getId();</span>
<span class="nc" id="L111">        }</span>

        @Override
        protected Set&lt;WebsocketChannel&gt; build(UserDao userDao, CardTypeDao cardTypeDao) {
<span class="nc" id="L115">            return Set.of(ProjectContentChannel.build(projectId));</span>
        }
    }

    /**
     * To build all channels needed to propagate a project overview alteration
     */
    public static class AboutProjectOverviewChannelsBuilder extends ChannelsBuilder {
        /** the id of the users that are team members */
        private final Set&lt;Long&gt; teamMemberUserIds;

        /**
         * Create a builder for the channels to use when a project overview data is changed
         *
         * @param project the project
         */
<span class="nc" id="L131">        public AboutProjectOverviewChannelsBuilder(Project project) {</span>
<span class="nc" id="L132">            teamMemberUserIds = retrieveTeamMemberUserIds(project);</span>
<span class="nc" id="L133">        }</span>

        @Override
        protected Set&lt;WebsocketChannel&gt; build(UserDao userDao, CardTypeDao cardTypeDao) {
<span class="nc" id="L137">            Set&lt;WebsocketChannel&gt; channels = new HashSet&lt;&gt;();</span>

<span class="nc" id="L139">            channels.addAll(teamMemberUserIds.stream()</span>
<span class="nc" id="L140">                .map(userId -&gt; UserChannel.build(userId))</span>
<span class="nc" id="L141">                .collect(Collectors.toSet()));</span>

<span class="nc" id="L143">            channels.addAll(buildAdminChannels(userDao));</span>

<span class="nc" id="L145">            return channels;</span>
        }
    }

    /**
     * To build a channel for each admin
     */
<span class="nc" id="L152">    public static class ForAdminChannelsBuilder extends ChannelsBuilder {</span>

        @Override
        protected Set&lt;WebsocketChannel&gt; build(UserDao userDao, CardTypeDao cardTypeDao) {
<span class="nc" id="L156">            return buildAdminChannels(userDao);</span>
        }
    }

    /**
     * To build all channels needed to propagate a user alteration
     */
    public static class AboutUserChannelsBuilder extends ChannelsBuilder {
        /** the id of the user */
        private final Long userId;
        /** the id of the users that are team mates */
        private final Set&lt;Long&gt; teamMatesUserIds;

        /**
         * Create a builder for the channels to use when a user is changed
         *
         * @param user the user
         */
<span class="nc" id="L174">        public AboutUserChannelsBuilder(User user) {</span>
<span class="nc" id="L175">            userId = user.getId();</span>
<span class="nc" id="L176">            teamMatesUserIds = retrieveTeamMatesUserId(user);</span>
<span class="nc" id="L177">        }</span>

        @Override
        protected Set&lt;WebsocketChannel&gt; build(UserDao userDao, CardTypeDao cardTypeDao) {
<span class="nc" id="L181">            Set&lt;WebsocketChannel&gt; channels = new HashSet&lt;&gt;();</span>

<span class="nc" id="L183">            channels.add(UserChannel.build(userId));</span>

<span class="nc" id="L185">            channels.addAll(teamMatesUserIds.stream()</span>
<span class="nc" id="L186">                .map(userId -&gt; UserChannel.build(userId))</span>
<span class="nc" id="L187">                .collect(Collectors.toSet()));</span>

<span class="nc" id="L189">            channels.addAll(buildAdminChannels(userDao));</span>

<span class="nc" id="L191">            return channels;</span>
        }
    }

    /**
     * To build all channels needed to propagate an account alteration
     */
    public static class AboutAccountChannelsBuilder extends ChannelsBuilder {
        /** the id of the user */
        private final Long userId;

        /**
         * Create a builder for the channels to use when an account is changed
         *
         * @param account the account
         */
<span class="nc" id="L207">        public AboutAccountChannelsBuilder(Account account) {</span>
<span class="nc" id="L208">            userId = account.getUser().getId();</span>
<span class="nc" id="L209">        }</span>

        @Override
        protected Set&lt;WebsocketChannel&gt; build(UserDao userDao, CardTypeDao cardTypeDao) {
<span class="nc" id="L213">            Set&lt;WebsocketChannel&gt; channels = new HashSet&lt;&gt;();</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (userId != null) {</span>
<span class="nc" id="L216">                channels.add(UserChannel.build(userId));</span>
            }

<span class="nc" id="L219">            channels.addAll(buildAdminChannels(userDao));</span>

<span class="nc" id="L221">            return channels;</span>
        }
    }

    /**
     * To build all channels needed for a card type belonging to a project
     */
    public static class AboutCardTypeChannelsBuilder extends ChannelsBuilder {
        /** the card type */
        private final AbstractCardType cardType;

        /**
         * Create a channel builder for everything needed for a card type belonging to a project
         *
         * @param cardType the card type
         */
<span class="nc" id="L237">        public AboutCardTypeChannelsBuilder(AbstractCardType cardType) {</span>
<span class="nc" id="L238">            this.cardType = cardType;</span>
<span class="nc" id="L239">        }</span>

        @Override
        protected Set&lt;WebsocketChannel&gt; build(UserDao userDao,
            CardTypeDao cardTypeDao) {
<span class="nc" id="L244">            return buildCardTypeInProjectChannel(cardType, userDao, cardTypeDao);</span>
        }

    }

    ////////////////////////////////////////////////////////////////////////////////////////////////
    // Helpers

    /**
     * Build a channel for each admin
     *
     * @param userDao To fetch the admin
     *
     * @return a set of channels : one user channel for each admin
     */
    private static Set&lt;WebsocketChannel&gt; buildAdminChannels(UserDao userDao) {
<span class="nc" id="L260">        return userDao.findAllAdmin().stream()</span>
<span class="nc" id="L261">            .map(user -&gt; UserChannel.build(user.getId()))</span>
<span class="nc" id="L262">            .collect(Collectors.toSet());</span>
    }

    /**
     * Retrieve the id of the users team mates of the given user
     *
     * @param user the user
     *
     * @return the ids of the users team mates
     */
    private static Set&lt;Long&gt; retrieveTeamMatesUserId(User user) {
<span class="nc" id="L273">        return user.getTeamMembers().stream()</span>
<span class="nc" id="L274">            .map(member -&gt; member.getProject())</span>
<span class="nc" id="L275">            .flatMap(project -&gt; {</span>
<span class="nc" id="L276">                return retrieveTeamMemberUserIds(project).stream();</span>
            })
<span class="nc" id="L278">            .collect(Collectors.toSet());</span>
    }

    /**
     * Retrieve the id of the user of the team members of the project
     *
     * @param project the project
     *
     * @return the project team members user ids
     */
    private static Set&lt;Long&gt; retrieveTeamMemberUserIds(Project project) {
<span class="nc" id="L289">        return project.getTeamMembers().stream()</span>
            // filter out pending invitation
<span class="nc bnc" id="L291" title="All 4 branches missed.">            .filter(member -&gt; member.getUser() != null &amp;&amp; member.getUser().getId() != null)</span>
<span class="nc" id="L292">            .map(member -&gt; member.getUser().getId())</span>
<span class="nc" id="L293">            .collect(Collectors.toSet());</span>
    }

    /**
     * Build a channel for each team member of the project
     *
     * @param project the project
     *
     * @return a set of user channels : one for each team member
     */
    private static Set&lt;WebsocketChannel&gt; buildTeamMemberChannels(Project project) {
<span class="nc" id="L304">        return project.getTeamMembers().stream()</span>
            // filter out pending invitation
<span class="nc bnc" id="L306" title="All 2 branches missed.">            .filter(member -&gt; member.getUser() != null)</span>
<span class="nc" id="L307">            .map(member -&gt; UserChannel.build(member.getUser().getId()))</span>
<span class="nc" id="L308">            .collect(Collectors.toSet());</span>
    }

    /**
     * Build all channels needed when a card type is changed
     *
     * @param cardType    the card type
     * @param userDao     to fetch the admin
     * @param cardTypeDao to fetch the references of a card type
     *
     * @return
     */
    private static Set&lt;WebsocketChannel&gt; buildCardTypeInProjectChannel(
        AbstractCardType cardType, UserDao userDao,
        CardTypeDao cardTypeDao) {
<span class="nc" id="L323">        Set&lt;WebsocketChannel&gt; channels = new HashSet&lt;&gt;();</span>

<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (cardType.getProject() != null) {</span>
            // this type belongs to a specific project
            // first, everyone who is editing the project shall receive updates
<span class="nc" id="L328">            channels.add(ProjectContentChannel.build(cardType.getProject().getId()));</span>

<span class="nc bnc" id="L330" title="All 2 branches missed.">            if (cardType.isOrWasPublished()) {</span>
                // eventually, published types are available to each project members
                // independently of the project they're editing
<span class="nc" id="L333">                channels.addAll(buildTeamMemberChannels(cardType.getProject()));</span>
            }

            // then, the type must be propagated to all projects which reference it
<span class="nc" id="L337">            cardType.getDirectReferences().forEach(ref -&gt; {</span>
<span class="nc" id="L338">                channels.addAll(buildCardTypeInProjectChannel(ref, userDao, cardTypeDao));</span>
<span class="nc" id="L339">            });</span>
        } else {
            // This is a global type
<span class="nc bnc" id="L342" title="All 2 branches missed.">            if (cardType.isOrWasPublished()) {</span>
                // As the type is published, everyone may use this type -&gt; broadcast
<span class="nc" id="L344">                channels.add(BroadcastChannel.build());</span>
            } else {
                // Not published type are only available to admin
<span class="nc" id="L347">                channels.addAll(buildAdminChannels(userDao));</span>
            }
        }

<span class="nc" id="L351">        return channels;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>