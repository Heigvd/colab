<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RequestManager.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-tests</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.ejb</a> &gt; <span class="el_source">RequestManager.java</span></div><h1>RequestManager.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.ejb;

import ch.colabproject.colab.api.model.user.Account;
import ch.colabproject.colab.api.model.user.User;
import ch.colabproject.colab.api.persistence.user.UserDao;
import ch.colabproject.colab.api.security.HttpSession;
import ch.colabproject.colab.api.security.permissions.Conditions.Condition;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.Callable;
import javax.enterprise.context.RequestScoped;
import javax.inject.Inject;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Request sidekick.
 *
 * @author maxence
 */
@RequestScoped
<span class="fc" id="L30">public class RequestManager {</span>

    /** logger */
<span class="fc" id="L33">    private static final Logger logger = LoggerFactory.getLogger(RequestManager.class);</span>

    /**
     * Access to the persistence unit
     */
    @PersistenceContext(unitName = &quot;COLAB_PU&quot;)
    private EntityManager em;

    /**
     * User-related business logic
     */
    @Inject
    private UserDao userDao;

    /**
     * Websocket business logic
     */
    @Inject
    private WebsocketFacade websocketFacade;

    /**
     * HTTP session associated to current request
     */
    private HttpSession httpSession;

    /**
     * Timestamp as return by {@link System#currentTimeMillis() } the request starts at
     */
    private long startTime;

    /**
     * Base url request URL
     */
    private String baseUrl;

    /**
     * Id of the current user account
     */
    private Long currentAccountId;

    /**
     * To store condition which have already been evaluated
     */
<span class="fc" id="L76">    private final Map&lt;Condition, Boolean&gt; conditionCache = new HashMap&lt;&gt;();</span>

    /**
     * Indicates if current user can act as an admin. 0 = no sudo greater than 0 =&gt; sudo
     */
<span class="fc" id="L81">    private int sudoAsAdmin = 0;</span>

    /**
     * is the thread run in the so-called security transaction ?
     */
<span class="fc" id="L86">    private boolean inSecurityTx = false;</span>

    /**
     * Is the current transaction already completed ?
     */
<span class="fc" id="L91">    private boolean txDone = false;</span>

    /**
     * Get request base url
     *
     * @return url
     */
    public String getBaseUrl() {
<span class="fc" id="L99">        return baseUrl;</span>
    }

    /**
     * Set the request base url
     *
     * @param baseUrl request base url
     */
    public void setBaseUrl(String baseUrl) {
<span class="fc" id="L108">        this.baseUrl = baseUrl;</span>
<span class="fc" id="L109">    }</span>

    /**
     *
     * @return the current http session
     */
    public HttpSession getHttpSession() {
<span class="fc" id="L116">        return this.httpSession;</span>
    }

    /**
     * Attach httpSession to this request
     *
     * @param httpSession http session
     */
    public void setHttpSession(HttpSession httpSession) {
<span class="fc" id="L125">        this.httpSession = httpSession;</span>
<span class="fc" id="L126">        User currentUser = getCurrentUser();</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">        if (currentUser != null) {</span>
<span class="fc" id="L128">            currentUser.touchLastSeenAt();</span>
        }
<span class="fc" id="L130">    }</span>

    /**
     * Get the current authenticated account
     *
     * @return the current account or null if none
     */
    public Account getCurrentAccount() {
<span class="fc bfc" id="L138" title="All 2 branches covered.">        if (this.httpSession != null) {</span>
<span class="fc" id="L139">            return userDao.findAccount(this.httpSession.getAccountId());</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">        } else if (this.currentAccountId != null) {</span>
<span class="fc" id="L141">            return userDao.findAccount(this.currentAccountId);</span>
        }
<span class="fc" id="L143">        return null;</span>
    }

    /**
     * Get the current authenticated user
     *
     * @return the current user or null if none
     */
    public User getCurrentUser() {
<span class="fc" id="L152">        Account account = this.getCurrentAccount();</span>

<span class="fc bfc" id="L154" title="All 2 branches covered.">        if (account != null) {</span>
<span class="fc" id="L155">            return account.getUser();</span>
        } else {
<span class="fc" id="L157">            return null;</span>
        }
    }

    /**
     * set time the current request started
     *
     * @param timestamp start timestamp
     *
     */
    public void setStartTime(long timestamp) {
<span class="fc" id="L168">        this.startTime = timestamp;</span>
<span class="fc" id="L169">    }</span>

    /**
     * Return the time the request started
     *
     * @return start time timestamp in ms
     */
    public long getStartTime() {
<span class="fc" id="L177">        return startTime;</span>
    }

    /**
     * Is the request ran by an authenticated user ?
     *
     * @return true if the current user is fully authenticated
     */
    public Boolean isAuthenticated() {
<span class="fc bfc" id="L186" title="All 2 branches covered.">        return this.getCurrentAccount() != null;</span>
    }

    /**
     * Set the current account.
     *
     * @param account new current account
     */
    public void login(Account account) {
<span class="fc" id="L195">        HttpSession session = this.getHttpSession();</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">        if (session != null) {</span>
<span class="fc" id="L197">            session.setAccountId(account.getId());</span>
        }
<span class="fc" id="L199">        this.currentAccountId = account.getId();</span>
<span class="fc" id="L200">    }</span>

    /**
     * Clear current account and unsubscribe from all websocket channels.
     */
    public void logout() {
<span class="fc" id="L206">        HttpSession session = this.getHttpSession();</span>
<span class="fc" id="L207">        this.currentAccountId = null;</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (session != null) {</span>
<span class="fc" id="L209">            session.setAccountId(null);</span>
<span class="fc" id="L210">            conditionCache.clear();</span>
<span class="fc" id="L211">            websocketFacade.signoutAndUnsubscribeFromAll(this.getHttpSession().getSessionId());</span>
        }
<span class="fc" id="L213">    }</span>

    private boolean txExists() {
<span class="fc bfc" id="L216" title="All 2 branches covered.">        return !this.txDone;</span>
    }

    /**
     * Execute some piece of code with admin privileges.
     *
     * @param action code to execute with admin privileges
     */
    public void sudo(Runnable action) {
<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (txExists()) {</span>
            // make sure to flush to check every pending changes before granting admin rights
<span class="fc" id="L227">            em.flush();</span>
        }

<span class="fc" id="L230">        this.sudoAsAdmin++;</span>
<span class="fc" id="L231">        logger.trace(&quot;Sudo #{}&quot;, this.sudoAsAdmin);</span>
<span class="fc" id="L232">        action.run();</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">        if (txExists()) {</span>
            // make sure to flush to apply all pending changes with admin rights
<span class="fc" id="L235">            em.flush();</span>
        }

<span class="fc" id="L238">        logger.trace(&quot;EndOfSudo #{}&quot;, this.sudoAsAdmin);</span>

<span class="fc" id="L240">        this.sudoAsAdmin--;</span>
<span class="fc" id="L241">    }</span>

    /**
     * Execute some piece of code with admin privileges and return something.
     *
     * @param &lt;R&gt;    return type
     * @param action code to execute with admin privileges
     *
     * @return action result
     *
     * @throws java.lang.Exception if something is thrown during the call
     */
    public &lt;R&gt; R sudo(Callable&lt;R&gt; action) throws Exception {
<span class="fc bfc" id="L254" title="All 2 branches covered.">        if (txExists()) {</span>
            // make sure to flush to check every pending changes before granting admin rights
<span class="fc" id="L256">            em.flush();</span>
        }
<span class="fc" id="L258">        this.sudoAsAdmin++;</span>
<span class="fc" id="L259">        logger.trace(&quot;Sudo #{}&quot;, this.sudoAsAdmin);</span>
<span class="fc" id="L260">        R result = action.call();</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">        if (txExists()) {</span>
            // make sure to flush to apply all pending changes with admin rights
<span class="fc" id="L263">            em.flush();</span>
        }
<span class="fc" id="L265">        logger.trace(&quot;EndOfSudo #{}&quot;, this.sudoAsAdmin);</span>
<span class="fc" id="L266">        this.sudoAsAdmin--;</span>

<span class="fc" id="L268">        return result;</span>
    }

    /**
     * Is the currentUser is an admin or sudo as an admin ?
     *
     * @return true if current user can act as an admin
     */
    public boolean isAdmin() {
        // the sudoAsAdmin is done at first,
        // so we do not need to get the current user if this condition is fulfilled
<span class="fc bfc" id="L279" title="All 2 branches covered.">        if (sudoAsAdmin &gt; 0) {</span>
<span class="fc" id="L280">            return true;</span>
        }

<span class="fc" id="L283">        User currentUser = this.getCurrentUser();</span>
<span class="fc bfc" id="L284" title="All 4 branches covered.">        return currentUser != null &amp;&amp; currentUser.isAdmin();</span>
    }

    /**
     * Register condition result
     *
     * @param condition the condition
     * @param result    the result
     */
    public void registerConditionResult(Condition condition, Boolean result) {
<span class="fc" id="L294">        this.conditionCache.put(condition, result);</span>
<span class="fc" id="L295">    }</span>

    /**
     * Get the cached condition result
     *
     * @param condition condition
     *
     * @return true or false if the condition is cached, null if the condition has not been
     *         evaluated yet
     */
    public Boolean getConditionResult(Condition condition) {
<span class="fc" id="L306">        return this.conditionCache.get(condition);</span>
    }

    /**
     * Is the thread run in a transaction dedicated to security condition evaluation
     *
     * @return true/false
     */
    public boolean isInSecurityTx() {
<span class="fc" id="L315">        return inSecurityTx;</span>
    }

    /**
     * Change the inSecurityTx flag
     *
     * @param inSecurityTx new flag
     */
    public void setInSecurityTx(boolean inSecurityTx) {
<span class="fc" id="L324">        this.inSecurityTx = inSecurityTx;</span>
<span class="fc" id="L325">    }</span>

    public boolean isTxDone() {
<span class="nc" id="L328">        return txDone;</span>
    }

    public void setTxDone(boolean txDone) {
<span class="fc" id="L332">        this.txDone = txDone;</span>
<span class="fc" id="L333">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>