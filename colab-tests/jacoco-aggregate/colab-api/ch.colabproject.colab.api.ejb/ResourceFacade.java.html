<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ResourceFacade.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-tests</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.ejb</a> &gt; <span class="el_source">ResourceFacade.java</span></div><h1>ResourceFacade.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.ejb;

import ch.colabproject.colab.api.model.card.Card;
import ch.colabproject.colab.api.model.card.CardContent;
import ch.colabproject.colab.api.model.card.CardType;
import ch.colabproject.colab.api.model.document.AbstractResource;
import ch.colabproject.colab.api.model.document.Document;
import ch.colabproject.colab.api.model.document.Resource;
import ch.colabproject.colab.api.model.document.ResourceRef;
import ch.colabproject.colab.api.model.link.StickyNoteLink;
import ch.colabproject.colab.api.persistence.card.CardContentDao;
import ch.colabproject.colab.api.persistence.card.CardDao;
import ch.colabproject.colab.api.persistence.card.CardTypeDao;
import ch.colabproject.colab.api.persistence.document.AbstractResourceDao;
//import ch.colabproject.colab.api.persistence.document.DocumentDao;
import ch.colabproject.colab.api.persistence.document.ResourceDao;
import ch.colabproject.colab.api.persistence.document.ResourceRefDao;
import ch.colabproject.colab.generator.model.exceptions.HttpErrorMessage;
import java.util.ArrayList;
import java.util.List;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.inject.Inject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Resource and resource reference specific logic
 *
 * @author sandra
 */
// TODO refine the publish / deprecated / refused effect
// TODO requestingForGlory handling
@Stateless
@LocalBean
<span class="fc" id="L42">public class ResourceFacade {</span>

    /** logger */
<span class="fc" id="L45">    private static final Logger logger = LoggerFactory.getLogger(ResourceFacade.class);</span>

    // *********************************************************************************************
    // injections
    // *********************************************************************************************

    /**
     * Resource persistence handling
     */
    @Inject
    private ResourceDao resourceDao;

    /**
     * Resource reference persistence handling
     */
    @Inject
    private ResourceRefDao resourceRefDao;

    /**
     * Resource / reference persistence handling
     */
    @Inject
    private AbstractResourceDao resourceOrRefDao;

    /**
     * Card type persistence handling
     */
    @Inject
    private CardTypeDao cardTypeDao;

    /**
     * Card persistence
     */
    @Inject
    private CardDao cardDao;

    /**
     * Card content persistence handling
     */
    @Inject
    private CardContentDao cardContentDao;

    /**
     * To check access rights
     */
    @Inject
    private SecurityFacade securityFacade;

    // *********************************************************************************************
    // resource access stuff
    // *********************************************************************************************

    /**
     * Find every resource directly linked or linked by reference to the card type.
     * &lt;p&gt;
     * The resources must be active and available for the card type.
     *
     * @param cardTypeId the id of the card type
     *
     * @return all resources that match
     */
    public List&lt;Resource&gt; getAvailableActiveResourcesLinkedToCardType(Long cardTypeId) {
<span class="fc" id="L107">        logger.debug(&quot;Get available active resources linked to car type #{}&quot;, cardTypeId);</span>

<span class="fc" id="L109">        CardType cardType = cardTypeDao.getCardType(cardTypeId);</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (cardType == null) {</span>
<span class="nc" id="L111">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

<span class="fc" id="L114">        return findAvailableAndActiveTargetResource(cardType.getDirectAbstractResources());</span>
    }

    /**
     * Find every resource directly linked or linked by reference to the card.
     * &lt;p&gt;
     * The resources must be active and available for the card.
     *
     * @param cardId the id of the card
     *
     * @return all resources that match
     */
    public List&lt;Resource&gt; getAvailableActiveResourcesLinkedToCard(Long cardId) {
<span class="fc" id="L127">        logger.debug(&quot;Get available active resources linked to card #{}&quot;, cardId);</span>

<span class="fc" id="L129">        Card card = cardDao.getCard(cardId);</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        if (card == null) {</span>
<span class="nc" id="L131">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

<span class="fc" id="L134">        return findAvailableAndActiveTargetResource(card.getDirectAbstractResources());</span>
    }

    /**
     * Find every resource directly linked or linked by reference to the card content.
     * &lt;p&gt;
     * The resources must be active and available for the card content.
     *
     * @param cardContentId the id of the card content
     *
     * @return all resources that match
     */
    public List&lt;Resource&gt; getAvailableActiveResourcesLinkedToCardContent(Long cardContentId) {
<span class="fc" id="L147">        logger.debug(&quot;Get available active resources linked to card content #{}&quot;, cardContentId);</span>

<span class="fc" id="L149">        CardContent cardContent = cardContentDao.getCardContent(cardContentId);</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if (cardContent == null) {</span>
<span class="nc" id="L151">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

<span class="fc" id="L154">        return findAvailableAndActiveTargetResource(cardContent.getDirectAbstractResources());</span>
    }

    /**
     * Find the resources at the end of the references chains.
     * &lt;p&gt;
     * Only the active and available resources are taken into account.
     *
     * @param baseAbstractResources The list of abstract resources to search from
     *
     * @return the resources that match
     */
    private List&lt;Resource&gt; findAvailableAndActiveTargetResource(
        List&lt;AbstractResource&gt; baseAbstractResources) {
<span class="fc" id="L168">        List&lt;Resource&gt; result = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L170" title="All 2 branches covered.">        for (AbstractResource abstractResource : baseAbstractResources) {</span>
<span class="fc" id="L171">            Resource resource = getAvailableActiveResource(abstractResource);</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">            if (resource != null) {</span>
<span class="fc" id="L173">                result.add(resource);</span>
            }
<span class="fc" id="L175">        }</span>

<span class="fc" id="L177">        return result;</span>
    }

    /**
     * Recursive method to get the resource at the end of each references chain.
     * &lt;p&gt;
     * Only the active and available resources are taken into account.
     *
     * @param abstractResource An abstract resource
     *
     * @return the resource at the end of each references chain as long as it is available and
     *         active
     */
    private Resource getAvailableActiveResource(AbstractResource abstractResource) {
<span class="fc bfc" id="L191" title="All 2 branches covered.">        if (abstractResource instanceof Resource) {</span>
<span class="fc" id="L192">            return (Resource) abstractResource;</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        } else if (abstractResource instanceof ResourceRef) {</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">            if (isResourceAvailableAndActive((ResourceRef) abstractResource)) {</span>
<span class="fc" id="L195">                return getAvailableActiveResource(</span>
<span class="fc" id="L196">                    ((ResourceRef) abstractResource).getTargetAbstractResource());</span>
            }
        } else {
<span class="nc" id="L199">            throw HttpErrorMessage.dataIntegrityFailure();</span>
        }

<span class="fc" id="L202">        return null;</span>
    }

    /**
     * Filter to only take into account resources that are available and active
     * &lt;p&gt;
     * &lt;ul&gt;
     * &lt;li&gt;a resource must be published to be passed the sub cards&lt;/li&gt;
     * &lt;li&gt;the reference must not be refused&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @param resourceRef the resource reference
     *
     * @return whether the resource can be taken into account or not
     */
    private boolean isResourceAvailableAndActive(ResourceRef resourceRef) {
<span class="fc" id="L218">        AbstractResource target = resourceRef.getTargetAbstractResource();</span>
<span class="fc bfc" id="L219" title="All 4 branches covered.">        if (resourceRef.hasCard() &amp;&amp; target.hasCardContent()</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">            &amp;&amp; !resourceRef.resolve().isPublished()) {</span>
<span class="fc" id="L221">            return false;</span>
        }

<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        return !resourceRef.isRefused();</span>
    }

    // *********************************************************************************************
    // resource creation stuff
    // *********************************************************************************************

    /**
     * Create a new resource for the document linked to the card type
     * &lt;p&gt;
     * Every child of the card type (recursively) acquires a reference to that resource or, for the
     * grandchildren, to a reference to that resource
     *
     * @param document   the document the resource represents
     * @param cardTypeId the id of the card type the resource must be linked to
     *
     * @return the brand new resource
     */
    public Resource createResourceForCardType(Document document, Long cardTypeId) {
<span class="fc" id="L243">        logger.debug(&quot;create a resource for document {} and card type #{}&quot;, document,</span>
            cardTypeId);

<span class="pc bpc" id="L246" title="1 of 2 branches missed.">        if (document == null) {</span>
<span class="nc" id="L247">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

        // A document can be related at max to one resource
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">        if (document.hasResource()) {</span>
<span class="nc" id="L252">            throw HttpErrorMessage.dataIntegrityFailure();</span>
        }

<span class="fc" id="L255">        CardType cardType = cardTypeDao.getCardType(cardTypeId);</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">        if (cardType == null) {</span>
<span class="nc" id="L257">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

<span class="fc" id="L260">        securityFacade.assertCanCreateResource(document, cardType);</span>

<span class="fc" id="L262">        Resource resource = Resource.initNewResource();</span>
<span class="fc" id="L263">        resource.setAbstractCardType(cardType);</span>
<span class="fc" id="L264">        cardType.getDirectAbstractResources().add(resource);</span>
<span class="fc" id="L265">        resource.setDocument(document);</span>
<span class="fc" id="L266">        document.setResource(resource);</span>

<span class="fc" id="L268">        resource = resourceDao.persistResource(resource);</span>

<span class="fc" id="L270">        createResourceRefForChildren(cardType, resource);</span>

<span class="fc" id="L272">        return resource;</span>
    }

    /**
     * Create a new resource for the document linked to the card
     * &lt;p&gt;
     * Every child of the card (recursively) acquires a reference to that resource or, for the
     * grandchildren, to a reference to that resource
     *
     * @param document the document the resource represents
     * @param cardId   the id of the card the resource must be linked to
     *
     * @return the brand new resource
     */
    public Resource createResourceForCard(Document document, Long cardId) {
<span class="fc" id="L287">        logger.debug(&quot;create a resource for document {} and card #{}&quot;, document, cardId);</span>

<span class="pc bpc" id="L289" title="1 of 2 branches missed.">        if (document == null) {</span>
<span class="nc" id="L290">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

        // A document can be related at max to one resource
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">        if (document.hasResource()) {</span>
<span class="nc" id="L295">            throw HttpErrorMessage.dataIntegrityFailure();</span>
        }

<span class="fc" id="L298">        Card card = cardDao.getCard(cardId);</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">        if (card == null) {</span>
<span class="nc" id="L300">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

<span class="fc" id="L303">        securityFacade.assertCanCreateResource(document, card);</span>

<span class="fc" id="L305">        Resource resource = Resource.initNewResource();</span>
<span class="fc" id="L306">        resource.setCard(card);</span>
<span class="fc" id="L307">        card.getDirectAbstractResources().add(resource);</span>
<span class="fc" id="L308">        resource.setDocument(document);</span>
<span class="fc" id="L309">        document.setResource(resource);</span>

<span class="fc" id="L311">        resource = resourceDao.persistResource(resource);</span>

<span class="fc" id="L313">        createResourceRefForChildren(card, resource);</span>

<span class="fc" id="L315">        return resource;</span>
    }

    /**
     * Create a new resource for the document linked to the card content
     * &lt;p&gt;
     * Every child of the card content (recursively) acquires a reference to that resource or, for
     * the grandchildren, to a reference to that resource
     *
     * @param document      the document the resource represents
     * @param cardContentId the id of the card content the resource must be linked to
     *
     * @return the brand new resource
     */
    public Resource createResourceForCardContent(Document document, Long cardContentId) {
<span class="fc" id="L330">        logger.debug(&quot;create a resource for document {} and card content #{}&quot;, document,</span>
            cardContentId);

<span class="pc bpc" id="L333" title="1 of 2 branches missed.">        if (document == null) {</span>
<span class="nc" id="L334">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

        // A document can be related at max to one resource
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">        if (document.hasResource()) {</span>
<span class="nc" id="L339">            throw HttpErrorMessage.dataIntegrityFailure();</span>
        }

<span class="fc" id="L342">        CardContent cardContent = cardContentDao.getCardContent(cardContentId);</span>
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">        if (cardContent == null) {</span>
<span class="nc" id="L344">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

<span class="fc" id="L347">        securityFacade.assertCanCreateResource(document, cardContent);</span>

<span class="fc" id="L349">        Resource resource = Resource.initNewResource();</span>
<span class="fc" id="L350">        resource.setCardContent(cardContent);</span>
<span class="fc" id="L351">        cardContent.getDirectAbstractResources().add(resource);</span>
<span class="fc" id="L352">        resource.setDocument(document);</span>
<span class="fc" id="L353">        document.setResource(resource);</span>

<span class="fc" id="L355">        resource = resourceDao.persistResource(resource);</span>

<span class="fc" id="L357">        createResourceRefForChildren(cardContent, resource);</span>

<span class="fc" id="L359">        return resource;</span>
    }

    /**
     * Each child of the card type acquires a reference to the resource.
     *
     * @param cardType the card type
     * @param resource the resource we are linking
     */
    private void createResourceRefForChildren(CardType cardType, AbstractResource resource) {
<span class="fc bfc" id="L369" title="All 2 branches covered.">        for (Card card : cardType.getImplementingCards()) {</span>
<span class="fc" id="L370">            ResourceRef resourceRef = ResourceRef.initNewResourceRef();</span>
<span class="fc" id="L371">            resourceRef.setTargetAbstractResource(resource);</span>
<span class="fc" id="L372">            resource.getSourceResourceRefs().add(resourceRef);</span>
<span class="fc" id="L373">            resourceRef.setCard(card);</span>
<span class="fc" id="L374">            card.getDirectAbstractResources().add(resourceRef);</span>

<span class="fc" id="L376">            resourceRefDao.persistResourceRef(resourceRef);</span>

<span class="fc" id="L378">            createResourceRefForChildren(card, resourceRef);</span>
<span class="fc" id="L379">        }</span>
<span class="fc" id="L380">    }</span>

    /**
     * Each child of the card acquires a reference to the resource.
     *
     * @param card     the card
     * @param resource the resource we are linking
     */
    private void createResourceRefForChildren(Card card, AbstractResource resource) {
<span class="fc bfc" id="L389" title="All 2 branches covered.">        for (CardContent cardContent : card.getContentVariants()) {</span>
<span class="fc" id="L390">            ResourceRef resourceRef = ResourceRef.initNewResourceRef();</span>
<span class="fc" id="L391">            resourceRef.setTargetAbstractResource(resource);</span>
<span class="fc" id="L392">            resource.getSourceResourceRefs().add(resourceRef);</span>
<span class="fc" id="L393">            resourceRef.setCardContent(cardContent);</span>
<span class="fc" id="L394">            cardContent.getDirectAbstractResources().add(resourceRef);</span>

<span class="fc" id="L396">            resourceRefDao.persistResourceRef(resourceRef);</span>

<span class="fc" id="L398">            createResourceRefForChildren(cardContent, resourceRef);</span>
<span class="fc" id="L399">        }</span>
<span class="fc" id="L400">    }</span>

    /**
     * Each child of the card content acquires a reference to the resource.
     *
     * @param cardContent the card content
     * @param resource    the resource we are linking
     */
    private void createResourceRefForChildren(CardContent cardContent, AbstractResource resource) {
<span class="fc bfc" id="L409" title="All 2 branches covered.">        for (Card card : cardContent.getSubCards()) {</span>
<span class="fc" id="L410">            ResourceRef resourceRef = ResourceRef.initNewResourceRef();</span>
<span class="fc" id="L411">            resourceRef.setTargetAbstractResource(resource);</span>
<span class="fc" id="L412">            resource.getSourceResourceRefs().add(resourceRef);</span>
<span class="fc" id="L413">            resourceRef.setCard(card);</span>
<span class="fc" id="L414">            card.getDirectAbstractResources().add(resourceRef);</span>

<span class="fc" id="L416">            resourceRefDao.persistResourceRef(resourceRef);</span>

<span class="fc" id="L418">            createResourceRefForChildren(card, resourceRef);</span>
<span class="fc" id="L419">        }</span>
<span class="fc" id="L420">    }</span>

    // *********************************************************************************************
    //
    // *********************************************************************************************

    /**
     * Get all sticky note links of which the given resource / reference is the source
     *
     * @param resourceOrRefId the id of the resource / reference
     *
     * @return all sticky note links linked to the resource / reference
     */
    public List&lt;StickyNoteLink&gt; getStickyNoteLinkAsSrc(Long resourceOrRefId) {
<span class="fc" id="L434">        logger.debug(&quot;get sticky note links where the abstract resource #{} is the source&quot;,</span>
            resourceOrRefId);
<span class="fc" id="L436">        AbstractResource resource = resourceOrRefDao.findResourceOrRef(resourceOrRefId);</span>
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">        if (resource == null) {</span>
<span class="nc" id="L438">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }
<span class="fc" id="L440">        return resource.getStickyNoteLinksAsSrc();</span>
    }

    // *********************************************************************************************
    //
    // *********************************************************************************************

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>