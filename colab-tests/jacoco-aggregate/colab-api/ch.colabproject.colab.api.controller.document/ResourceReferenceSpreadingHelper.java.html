<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ResourceReferenceSpreadingHelper.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-tests</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.controller.document</a> &gt; <span class="el_source">ResourceReferenceSpreadingHelper.java</span></div><h1>ResourceReferenceSpreadingHelper.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.controller.document;

import ch.colabproject.colab.api.model.card.AbstractCardType;
import ch.colabproject.colab.api.model.card.Card;
import ch.colabproject.colab.api.model.card.CardContent;
import ch.colabproject.colab.api.model.card.CardTypeRef;
import ch.colabproject.colab.api.model.document.AbstractResource;
import ch.colabproject.colab.api.model.document.Resource;
import ch.colabproject.colab.api.model.document.ResourceRef;
import java.util.List;

/**
 * Resource and resource reference spread specific logic
 *
 * @author sandra
 */
public final class ResourceReferenceSpreadingHelper {

<span class="nc" id="L25">    private ResourceReferenceSpreadingHelper() {</span>
<span class="nc" id="L26">        throw new UnsupportedOperationException(&quot;do not instantiate a utility class&quot;);</span>
    }

    // *********************************************************************************************
    // when a resource / resource reference is added, spread it down stream with references
    // *********************************************************************************************

    /**
     * Each child of the card type acquires a reference to the resource.
     *
     * @param cardTypeOrRef the card type or card type reference
     * @param resourceOrRef the resource we are linking
     */
    public static void spreadReferenceDown(AbstractCardType cardTypeOrRef,
        AbstractResource resourceOrRef) {
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">        if (mustSpreadReferenceDown(resourceOrRef)) {</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">            for (AbstractCardType cardTypeRef : cardTypeOrRef.getDirectReferences()) {</span>
<span class="fc" id="L43">                makeResourceReference(cardTypeRef, resourceOrRef);</span>
<span class="fc" id="L44">            }</span>

<span class="fc bfc" id="L46" title="All 2 branches covered.">            for (Card card : cardTypeOrRef.getImplementingCards()) {</span>
<span class="fc" id="L47">                makeResourceReference(card, resourceOrRef);</span>
<span class="fc" id="L48">            }</span>
        }
<span class="fc" id="L50">    }</span>

    /**
     * Each child of the card acquires a reference to the resource.
     *
     * @param card          the card
     * @param resourceOrRef the resource we are linking
     */
    public static void spreadReferenceDown(Card card, AbstractResource resourceOrRef) {
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (mustSpreadReferenceDown(resourceOrRef)) {</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">            for (CardContent cardContent : card.getContentVariants()) {</span>
<span class="fc" id="L61">                makeResourceReference(cardContent, resourceOrRef);</span>
<span class="fc" id="L62">            }</span>
        }
<span class="fc" id="L64">    }</span>

    /**
     * Each child of the card content acquires a reference to the resource.
     *
     * @param cardContent   the card content
     * @param resourceOrRef the resource we are linking
     */
    public static void spreadReferenceDown(CardContent cardContent,
        AbstractResource resourceOrRef) {
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (mustSpreadReferenceDown(resourceOrRef)) {</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">            for (Card card : cardContent.getSubCards()) {</span>
<span class="fc" id="L76">                makeResourceReference(card, resourceOrRef);</span>
<span class="fc" id="L77">            }</span>
        }
<span class="fc" id="L79">    }</span>

    // *********************************************************************************************
    // when a card type reference / card / card content is added,
    // initialize the references from parent's resources / resource references
    // *********************************************************************************************

    /**
     * Create a resource reference for each resource / resource reference of the parent that must be
     * spread
     *
     * @param cardTypeRefToFill A new card type reference that need references to the up stream
     *                          resources
     */
    public static void spreadResourceFromUp(CardTypeRef cardTypeRefToFill) {
<span class="fc" id="L94">        AbstractCardType target = cardTypeRefToFill.getTarget();</span>

<span class="fc bfc" id="L96" title="All 2 branches covered.">        for (AbstractResource targetResource : target.getDirectAbstractResources()) {</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">            if (mustSpreadReferenceDown(targetResource)) {</span>
<span class="fc" id="L98">                makeResourceReference(cardTypeRefToFill, targetResource);</span>
            }
<span class="fc" id="L100">        }</span>
<span class="fc" id="L101">    }</span>

    /**
     * Create a resource reference for each resource / resource reference of the parent that must be
     * spread
     *
     * @param cardToFill A new card that need references to the up stream resources
     */
    public static void spreadResourceFromUp(Card cardToFill) {
<span class="fc" id="L110">        CardContent parent = cardToFill.getParent();</span>

<span class="fc bfc" id="L112" title="All 2 branches covered.">        for (AbstractResource parentResource : parent.getDirectAbstractResources()) {</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">            if (mustSpreadReferenceDown(parentResource)) {</span>
<span class="fc" id="L114">                makeResourceReference(cardToFill, parentResource);</span>
            }
<span class="fc" id="L116">        }</span>

<span class="fc" id="L118">        AbstractCardType type = cardToFill.getCardType();</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">        for (AbstractResource typeResource : type.getDirectAbstractResources()) {</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">            if (mustSpreadReferenceDown(typeResource)) {</span>
<span class="fc" id="L122">                makeResourceReference(cardToFill, typeResource);</span>
            }
<span class="fc" id="L124">        }</span>
<span class="fc" id="L125">    }</span>

    /**
     * Create a resource reference for each resource / resource reference of the parent that must be
     * spread
     *
     * @param cardContentToFill A new card content that need references to the up stream resources
     */
    public static void spreadResourceFromUp(CardContent cardContentToFill) {
<span class="fc" id="L134">        Card parent = cardContentToFill.getCard();</span>

<span class="fc" id="L136">        List&lt;AbstractResource&gt; parentResources = parent.getDirectAbstractResources();</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">        for (AbstractResource parentResource : parentResources) {</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">            if (mustSpreadReferenceDown(parentResource)) {</span>
<span class="fc" id="L139">                makeResourceReference(cardContentToFill, parentResource);</span>
            }
<span class="fc" id="L141">        }</span>
<span class="fc" id="L142">    }</span>

    // *********************************************************************************************
    // do it
    // *********************************************************************************************

    /**
     * Ascertain if we must create resource references down stream
     *
     * @param resourceOrRef Resource / resource reference
     *
     * @return True iff the resource must be spread down
     */
    private static boolean mustSpreadReferenceDown(AbstractResource resourceOrRef) {
        // do not spread references of a type from a card content to its sub cards
<span class="fc" id="L157">        boolean isResourceOrRefLinkedToACardContent = resourceOrRef.hasCardContent();</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">        if (isResourceOrRefLinkedToACardContent) {</span>
<span class="fc" id="L159">            Resource concreteResource = resourceOrRef.resolve();</span>

<span class="pc bpc" id="L161" title="1 of 2 branches missed.">            boolean isConcreteResourceLinkedToACardType = concreteResource != null</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">                &amp;&amp; concreteResource.hasAbstractCardType();</span>

<span class="fc bfc" id="L164" title="All 2 branches covered.">            return !isConcreteResourceLinkedToACardType;</span>
        }

        // in all other cases, spread
<span class="fc" id="L168">        return true;</span>
    }

    /**
     * Make a resource reference to link to the given owner, from the given resource or reference
     * (or reference)
     *
     * @param owner         the entity the new resource reference will be linked to
     * @param resourceOrRef the resource (or reference) target of the new resource reference
     */
    private static void makeResourceReference(AbstractCardType owner,
        AbstractResource resourceOrRef) {

<span class="fc" id="L181">        ResourceRef resourceRef = initNewReferenceFrom(resourceOrRef);</span>

<span class="fc" id="L183">        resourceRef.setAbstractCardType(owner);</span>
<span class="fc" id="L184">        owner.getDirectAbstractResources().add(resourceRef);</span>

<span class="fc" id="L186">        spreadReferenceDown(owner, resourceRef);</span>
<span class="fc" id="L187">    }</span>

    /**
     * Make a resource reference to link to the given owner, from the given resource or reference
     * (or reference)
     *
     * @param owner         the entity the new resource reference will be linked to
     * @param resourceOrRef the resource (or reference) target of the new resource reference
     */
    private static void makeResourceReference(CardContent owner, AbstractResource resourceOrRef) {
<span class="fc" id="L197">        ResourceRef resourceRef = initNewReferenceFrom(resourceOrRef);</span>

<span class="fc" id="L199">        resourceRef.setCardContent(owner);</span>
<span class="fc" id="L200">        owner.getDirectAbstractResources().add(resourceRef);</span>

<span class="fc" id="L202">        spreadReferenceDown(owner, resourceRef);</span>
<span class="fc" id="L203">    }</span>

    /**
     * Make a resource reference to link to the given owner, from the given resource or reference
     * (or reference)
     *
     * @param owner         the entity the new resource reference will be linked to
     * @param resourceOrRef the resource (or reference) target of the new resource reference
     */
    private static void makeResourceReference(Card owner, AbstractResource resourceOrRef) {
<span class="fc" id="L213">        ResourceRef resourceRef = initNewReferenceFrom(resourceOrRef);</span>

<span class="fc" id="L215">        resourceRef.setCard(owner);</span>
<span class="fc" id="L216">        owner.getDirectAbstractResources().add(resourceRef);</span>

<span class="fc" id="L218">        spreadReferenceDown(owner, resourceRef);</span>
<span class="fc" id="L219">    }</span>

    /**
     * Initialize a new reference to the target resource / resource reference
     *
     * @param target Base resource / resource reference
     *
     * @return the new resource reference
     */
    private static ResourceRef initNewReferenceFrom(AbstractResource target) {
<span class="fc" id="L229">        ResourceRef reference = new ResourceRef();</span>

<span class="fc" id="L231">        reference.setCategory(target.getCategory());</span>

<span class="fc" id="L233">        reference.setRefused(isNewReferenceInitiallyRefused(target));</span>

<span class="fc" id="L235">        reference.setTarget(target);</span>
<span class="fc" id="L236">        target.getDirectReferences().add(reference);</span>

<span class="fc" id="L238">        return reference;</span>
    }

    /**
     * Determine if the new reference must be initiated as refused
     *
     * @param target Base resource / resource reference
     *
     * @return how the new reference refused field must be initialized
     */
    private static boolean isNewReferenceInitiallyRefused(AbstractResource target) {
<span class="fc bfc" id="L249" title="All 2 branches covered.">        if (target instanceof ResourceRef) {</span>
            // if it is from a reference, just copy the refused state
<span class="fc" id="L251">            return ((ResourceRef) target).isRefused();</span>
        }

        // if it is from a concrete resource, set to true if deprecated
<span class="pc bpc" id="L255" title="2 of 4 branches missed.">        if (target instanceof Resource &amp;&amp; ((Resource) target).resolve().isDeprecated()) {</span>
<span class="nc" id="L256">            return true;</span>
        }

<span class="fc" id="L259">        return false;</span>
    }

    // *********************************************************************************************
    //
    // *********************************************************************************************

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>