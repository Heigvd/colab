<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ResourceReferenceSpreadingHelper.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-tests</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.controller.document</a> &gt; <span class="el_source">ResourceReferenceSpreadingHelper.java</span></div><h1>ResourceReferenceSpreadingHelper.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.controller.document;

import ch.colabproject.colab.api.model.card.AbstractCardType;
import ch.colabproject.colab.api.model.card.Card;
import ch.colabproject.colab.api.model.card.CardContent;
import ch.colabproject.colab.api.model.card.CardTypeRef;
import ch.colabproject.colab.api.model.document.AbstractResource;
import ch.colabproject.colab.api.model.document.Resource;
import ch.colabproject.colab.api.model.document.ResourceRef;
import java.util.List;

/**
 * Resource and resource reference spread specific logic
 *
 * @author sandra
 */
public final class ResourceReferenceSpreadingHelper {

<span class="nc" id="L25">    private ResourceReferenceSpreadingHelper() {</span>
<span class="nc" id="L26">        throw new UnsupportedOperationException();</span>
    }

    // *********************************************************************************************
    // when a resource / resource reference is created, spread it down stream with references
    // *********************************************************************************************

    /**
     * Each child of the card type acquires a reference to the resource.
     *
     * @param cardTypeOrRef the card type or card type reference
     * @param resourceOrRef the resource we are linking
     */
    public static void spreadReferenceDown(AbstractCardType cardTypeOrRef,
        AbstractResource resourceOrRef) {
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">        if (mustSpreadReference(resourceOrRef)) {</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">            for (AbstractCardType cardTypeRef : cardTypeOrRef.getDirectReferences()) {</span>
<span class="fc" id="L43">                ResourceRef resourceRef = initNewResourceRef();</span>

<span class="fc" id="L45">                resourceRef.setTarget(resourceOrRef);</span>
<span class="fc" id="L46">                resourceOrRef.getDirectReferences().add(resourceRef);</span>

<span class="fc" id="L48">                resourceRef.setAbstractCardType(cardTypeRef);</span>
<span class="fc" id="L49">                cardTypeRef.getDirectAbstractResources().add(resourceRef);</span>

<span class="fc" id="L51">                spreadReferenceDown(cardTypeRef, resourceRef);</span>
<span class="fc" id="L52">            }</span>

<span class="fc bfc" id="L54" title="All 2 branches covered.">            for (Card card : cardTypeOrRef.getImplementingCards()) {</span>
<span class="fc" id="L55">                ResourceRef cardResourceRef = initNewResourceRef();</span>

<span class="fc" id="L57">                cardResourceRef.setTarget(resourceOrRef);</span>
<span class="fc" id="L58">                resourceOrRef.getDirectReferences().add(cardResourceRef);</span>

<span class="fc" id="L60">                cardResourceRef.setCard(card);</span>
<span class="fc" id="L61">                card.getDirectAbstractResources().add(cardResourceRef);</span>

<span class="fc" id="L63">                spreadReferenceDown(card, cardResourceRef);</span>
<span class="fc" id="L64">            }</span>
        }
<span class="fc" id="L66">    }</span>

    /**
     * Each child of the card acquires a reference to the resource.
     *
     * @param card          the card
     * @param resourceOrRef the resource we are linking
     */
    public static void spreadReferenceDown(Card card, AbstractResource resourceOrRef) {
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">        if (mustSpreadReference(resourceOrRef)) {</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">            for (CardContent cardContent : card.getContentVariants()) {</span>
<span class="fc" id="L77">                ResourceRef resourceRef = initNewResourceRef();</span>

<span class="fc" id="L79">                resourceRef.setTarget(resourceOrRef);</span>
<span class="fc" id="L80">                resourceOrRef.getDirectReferences().add(resourceRef);</span>

<span class="fc" id="L82">                resourceRef.setCardContent(cardContent);</span>
<span class="fc" id="L83">                cardContent.getDirectAbstractResources().add(resourceRef);</span>

<span class="fc" id="L85">                spreadReferenceDown(cardContent, resourceRef);</span>
<span class="fc" id="L86">            }</span>
        }
<span class="fc" id="L88">    }</span>

    /**
     * Each child of the card content acquires a reference to the resource.
     *
     * @param cardContent   the card content
     * @param resourceOrRef the resource we are linking
     */
    public static void spreadReferenceDown(CardContent cardContent,
        AbstractResource resourceOrRef) {
<span class="fc bfc" id="L98" title="All 2 branches covered.">        if (mustSpreadReference(resourceOrRef)) {</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">            for (Card card : cardContent.getSubCards()) {</span>
<span class="fc" id="L100">                ResourceRef resourceRef = initNewResourceRef();</span>

<span class="fc" id="L102">                resourceRef.setTarget(resourceOrRef);</span>
<span class="fc" id="L103">                resourceOrRef.getDirectReferences().add(resourceRef);</span>

<span class="fc" id="L105">                resourceRef.setCard(card);</span>
<span class="fc" id="L106">                card.getDirectAbstractResources().add(resourceRef);</span>

<span class="fc" id="L108">                spreadReferenceDown(card, resourceRef);</span>
<span class="fc" id="L109">            }</span>
        }
<span class="fc" id="L111">    }</span>

    /**
     * Ascertain if we must create resource references down stream
     *
     * @param resourceOrRef Resource / resource reference
     *
     * @return True if the resource must be spread down
     */
    private static boolean mustSpreadReference(AbstractResource resourceOrRef) {
        // do not spread references of a type from a card content to its subcards
<span class="fc bfc" id="L122" title="All 2 branches covered.">        if (resourceOrRef.hasCardContent()) {</span>
<span class="fc" id="L123">            Resource concreteResource = resourceOrRef.resolve();</span>
<span class="pc bpc" id="L124" title="1 of 4 branches missed.">            return concreteResource != null &amp;&amp; !concreteResource.hasAbstractCardType();</span>
        }

        // in all other cases, spread
<span class="fc" id="L128">        return true;</span>
    }

    /**
     * @return an initialized new resource reference
     */
    private static ResourceRef initNewResourceRef() {
        // implicitly setRefused(false)
<span class="fc" id="L136">        return new ResourceRef();</span>
    }

    // *********************************************************************************************
    // when a card / card content is created,
    // initialize the references from parent's resources / resource references
    // *********************************************************************************************

    /**
     * Create a resource reference for each resource / resource reference of the parent that must be
     * spread
     *
     * @param cardTypeRefToFill A new card type reference that need references to the up stream
     *                          resources
     */
    public static void spreadResourceFromUp(CardTypeRef cardTypeRefToFill) {
<span class="fc" id="L152">        AbstractCardType parent = cardTypeRefToFill.getTarget();</span>

<span class="fc" id="L154">        List&lt;AbstractResource&gt; parentResources = parent.getDirectAbstractResources();</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        for (AbstractResource parentResource : parentResources) {</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">            if (mustSpreadReference(parentResource)) {</span>
<span class="fc" id="L157">                ResourceRef reference = initNewReferenceFrom(parentResource);</span>

<span class="fc" id="L159">                reference.setAbstractCardType(cardTypeRefToFill);</span>
<span class="fc" id="L160">                cardTypeRefToFill.getDirectAbstractResources().add(reference);</span>

<span class="fc" id="L162">                spreadReferenceDown(cardTypeRefToFill, reference);</span>
            }
<span class="fc" id="L164">        }</span>
<span class="fc" id="L165">    }</span>

    /**
     * Create a resource reference for each resource / resource reference of the parent that must be
     * spread
     *
     * @param cardToFill A new card that need references to the up stream resources
     */
    public static void spreadResourceFromUp(Card cardToFill) {
<span class="fc" id="L174">        CardContent parent = cardToFill.getParent();</span>

<span class="fc" id="L176">        List&lt;AbstractResource&gt; parentResources = parent.getDirectAbstractResources();</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">        for (AbstractResource parentResource : parentResources) {</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">            if (mustSpreadReference(parentResource)) {</span>
<span class="fc" id="L179">                ResourceRef reference = initNewReferenceFrom(parentResource);</span>

<span class="fc" id="L181">                reference.setCard(cardToFill);</span>
<span class="fc" id="L182">                cardToFill.getDirectAbstractResources().add(reference);</span>

<span class="fc" id="L184">                spreadReferenceDown(cardToFill, reference);</span>
            }
<span class="fc" id="L186">        }</span>

<span class="fc" id="L188">        AbstractCardType type = cardToFill.getCardType();</span>
<span class="fc" id="L189">        List&lt;AbstractResource&gt; typeResources = type.getDirectAbstractResources();</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">        for (AbstractResource typeResource : typeResources) {</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">            if (mustSpreadReference(typeResource)) {</span>
<span class="fc" id="L192">                ResourceRef reference = initNewReferenceFrom(typeResource);</span>

<span class="fc" id="L194">                reference.setCard(cardToFill);</span>
<span class="fc" id="L195">                cardToFill.getDirectAbstractResources().add(reference);</span>

<span class="fc" id="L197">                spreadReferenceDown(cardToFill, reference);</span>
            }
<span class="fc" id="L199">        }</span>
<span class="fc" id="L200">    }</span>

    /**
     * Create a resource reference for each resource / resource reference of the parent that must be
     * spread
     *
     * @param cardContentToFill A new card content that need references to the up stream resources
     */
    public static void spreadResourceFromUp(CardContent cardContentToFill) {
<span class="fc" id="L209">        Card parent = cardContentToFill.getCard();</span>

<span class="fc" id="L211">        List&lt;AbstractResource&gt; parentResources = parent.getDirectAbstractResources();</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">        for (AbstractResource parentResource : parentResources) {</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">            if (mustSpreadReference(parentResource)) {</span>
<span class="fc" id="L214">                ResourceRef reference = initNewReferenceFrom(parentResource);</span>

<span class="fc" id="L216">                reference.setCardContent(cardContentToFill);</span>
<span class="fc" id="L217">                cardContentToFill.getDirectAbstractResources().add(reference);</span>

<span class="fc" id="L219">                spreadReferenceDown(cardContentToFill, reference);</span>
            }
<span class="fc" id="L221">        }</span>
<span class="fc" id="L222">    }</span>

    /**
     * Initialize a new reference to the target resource / resource reference
     *
     * @param target Base resource / resource reference
     *
     * @return The new resource reference
     */
    private static ResourceRef initNewReferenceFrom(AbstractResource target) {
<span class="fc" id="L232">        ResourceRef reference = new ResourceRef();</span>

<span class="fc" id="L234">        reference.setCategory(target.getCategory());</span>

<span class="fc bfc" id="L236" title="All 2 branches covered.">        if (target instanceof ResourceRef) {</span>
<span class="fc" id="L237">            Resource concreteResource = ((ResourceRef) target).resolve();</span>
<span class="pc bpc" id="L238" title="2 of 4 branches missed.">            if (concreteResource != null &amp;&amp; concreteResource.isDeprecated()) {</span>
<span class="nc" id="L239">                reference.setRefused(true);</span>
            } else {
<span class="fc" id="L241">                reference.setRefused(((ResourceRef) target).isRefused());</span>
            }
        }

<span class="fc" id="L245">        reference.setTarget(target);</span>
<span class="fc" id="L246">        target.getDirectReferences().add(reference);</span>

<span class="fc" id="L248">        return reference;</span>
    }

    // *********************************************************************************************
    //
    // *********************************************************************************************

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>