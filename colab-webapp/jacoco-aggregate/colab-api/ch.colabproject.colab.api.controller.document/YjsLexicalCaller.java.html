<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>YjsLexicalCaller.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-webapp</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.controller.document</a> &gt; <span class="el_source">YjsLexicalCaller.java</span></div><h1>YjsLexicalCaller.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021-2023 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.controller.document;

import ch.colabproject.colab.api.model.document.LexicalDataOwnershipKind;
import ch.colabproject.colab.api.setup.ColabConfiguration;

import org.apache.hc.client5.http.classic.HttpClient;
import org.apache.hc.client5.http.classic.methods.HttpPost;
import org.apache.hc.client5.http.classic.methods.HttpGet;
import org.apache.hc.client5.http.impl.classic.HttpClientBuilder;
import org.apache.hc.core5.http.HttpMessage;
import org.apache.hc.core5.http.HttpResponse;
import org.apache.hc.core5.http.HttpStatus;
import org.apache.hc.core5.net.URIBuilder;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * To manage the data in the colab-yjs server (that is used to store the lexical
 * text editor data).
 *
 * @author sandra
 */
public class YjsLexicalCaller {
    /** Logger */
<span class="nc" id="L31">    private static final Logger logger = LoggerFactory.getLogger(YjsLexicalCaller.class);</span>

    /** Duplicate URL */
    private static final String DUPLICATE_URL = &quot;duplicate&quot;;

    /** OwnerId parameter */
    private static final String PARAM_OWNER_ID = &quot;ownerId&quot;;

    /** Kind parameter */
    private static final String PARAM_KIND = &quot;kind&quot;;

    /** ToDuplicateId parameter */
    private static final String PARAM_DUPLICATE_ID = &quot;toDuplicateId&quot;;

    /** ToDuplicatedKind parameter */
    private static final String PARAM_DUPLICATE_KIND = &quot;toDuplicateKind&quot;;

    /** HTTP client */
    private final HttpClient client;

    /** Internal YJS URL */
    private final String internalUrl;

    // private String cookie;

    /**
     * Constructor.
     * &lt;p&gt;
     * Initialize the client and base URL
     */
<span class="nc" id="L61">    public YjsLexicalCaller(/* String cookie */) {</span>
<span class="nc" id="L62">        this.client = HttpClientBuilder.create().build();</span>
<span class="nc" id="L63">        this.internalUrl = ColabConfiguration.getYjsInternalUrl();</span>
        // this.cookie = cookie;
<span class="nc" id="L65">    }</span>

    /**
     * Send a request to duplicate a lexical data of a source owner to a destination
     * owner
     *
     * @param srcOwnerId    the id of the original owner
     * @param srcOwnerKind  the kind of the original owner
     * @param destOwnerId   the id of the new owner
     * @param destOwnerkind the kind of the new owner
     */
    public void sendDuplicationRequest(Long srcOwnerId, LexicalDataOwnershipKind srcOwnerKind,
            Long destOwnerId, LexicalDataOwnershipKind destOwnerkind) {

<span class="nc" id="L79">        logger.trace(&quot;internal url : &quot; + internalUrl);</span>

<span class="nc" id="L81">        HttpResponse response = null;</span>
        try {
<span class="nc" id="L83">            URIBuilder builder = new URIBuilder(internalUrl + &quot;/&quot; + DUPLICATE_URL);</span>
<span class="nc" id="L84">            builder.addParameter(PARAM_DUPLICATE_ID, Long.toString(srcOwnerId));</span>
<span class="nc" id="L85">            builder.addParameter(PARAM_DUPLICATE_KIND, srcOwnerKind.getKeyword());</span>
<span class="nc" id="L86">            builder.addParameter(PARAM_OWNER_ID, Long.toString(destOwnerId));</span>
<span class="nc" id="L87">            builder.addParameter(PARAM_KIND, destOwnerkind.getKeyword());</span>

<span class="nc" id="L89">            HttpPost request = new HttpPost(builder.build());</span>

<span class="nc" id="L91">            setHeaders(request);</span>

<span class="nc" id="L93">            logger.debug(&quot;duplicate : &quot; + request.getRequestUri());</span>

<span class="nc" id="L95">            response = client.execute(request);</span>

<span class="nc" id="L97">        } catch (Throwable cause) {</span>
<span class="nc" id="L98">            throw new YjsException(cause);</span>
<span class="nc" id="L99">        }</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (response == null) {</span>
<span class="nc" id="L102">            throw new YjsException(&quot;No response&quot;);</span>
        }

<span class="nc" id="L105">        logger.debug(&quot;duplication return code &quot; + response.getCode());</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (response.getCode() &gt;= HttpStatus.SC_CLIENT_ERROR) {</span>
<span class="nc" id="L108">            throw new YjsException(</span>
<span class="nc" id="L109">                    &quot;code &quot; + response.getCode() + &quot; : &quot; + response.getReasonPhrase());</span>
        }
<span class="nc" id="L111">    }</span>

    /**
     * Set HTTP message headers
     *
     * @param msg the HTTP message
     */
    private void setHeaders(HttpMessage msg) {
<span class="nc" id="L119">        msg.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L120">        msg.setHeader(&quot;Accept&quot;, &quot;*/*&quot;);</span>
        // msg.setHeader(&quot;Cookie&quot;, cookie);
<span class="nc" id="L122">        msg.setHeader(&quot;Managed-Mode&quot;, &quot;false&quot;);</span>
<span class="nc" id="L123">        msg.setHeader(&quot;User-Agent&quot;, &quot;coLAB&quot;);</span>
        // msg.setHeader(&quot;Authorization&quot;, auth);
<span class="nc" id="L125">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>