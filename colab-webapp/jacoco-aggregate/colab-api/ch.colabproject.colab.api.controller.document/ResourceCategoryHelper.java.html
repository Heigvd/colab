<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ResourceCategoryHelper.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-webapp</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.controller.document</a> &gt; <span class="el_source">ResourceCategoryHelper.java</span></div><h1>ResourceCategoryHelper.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.controller.document;

import ch.colabproject.colab.api.controller.card.CardContentManager;
import ch.colabproject.colab.api.controller.card.CardManager;
import ch.colabproject.colab.api.controller.card.CardTypeManager;
import ch.colabproject.colab.api.model.card.AbstractCardType;
import ch.colabproject.colab.api.model.card.Card;
import ch.colabproject.colab.api.model.card.CardContent;
import ch.colabproject.colab.api.model.document.AbstractResource;
import ch.colabproject.colab.api.model.document.ResourceRef;
import ch.colabproject.colab.api.persistence.jpa.card.CardTypeDao;
import ch.colabproject.colab.api.persistence.jpa.document.ResourceDao;
import ch.colabproject.colab.generator.model.exceptions.HttpErrorMessage;
import java.util.List;
import java.util.Objects;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.inject.Inject;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Resource and resource reference category specific logic
 *
 * @author sandra
 */
@Stateless
@LocalBean
<span class="nc" id="L36">public class ResourceCategoryHelper {</span>

    /** logger */
<span class="nc" id="L39">    private static final Logger logger = LoggerFactory.getLogger(ResourceCategoryHelper.class);</span>

    // *********************************************************************************************
    // injections

    /**
     * Resource persistence handler
     */
    @Inject
    private ResourceDao resourceDao;

    /**
     * Card type persistence handler
     */
    @Inject
    private CardTypeDao cardTypeDao;

    /**
     * Resource / resource reference related logic
     */
    @Inject
    private ResourceManager resourceManager;

    /**
     * Card type specific logic management
     */
    @Inject
    private CardTypeManager cardTypeManager;

    /**
     * Card specific logic management
     */
    @Inject
    private CardManager cardManager;

    /**
     * Card content specific logic management
     */
    @Inject
    private CardContentManager cardContentManager;

    // *********************************************************************************************
    // Category management
    // *********************************************************************************************

    /**
     * Set the category of the resource.
     * &lt;p&gt;
     * Also update the resources that reference this one, as long as we stay in the same project and
     * the category is synchronized
     *
     * @param resourceOrRefId the id of the resource / resource reference
     * @param categoryName    the name of the category that apply to the resource / resource
     *                        reference
     */
    public void changeCategory(Long resourceOrRefId, String categoryName) {
<span class="nc" id="L95">        logger.debug(&quot;set category {} to abstract resource #{}&quot;, categoryName, resourceOrRefId);</span>

<span class="nc" id="L97">        AbstractResource resourceOrRef = resourceManager.assertAndGetResourceOrRef(resourceOrRefId);</span>

<span class="nc" id="L99">        String oldCategoryName = resourceOrRef.getCategory();</span>
<span class="nc" id="L100">        String newCategoryName = StringUtils.trimToNull(categoryName);</span>

<span class="nc" id="L102">        resourceOrRef.setCategory(newCategoryName);</span>

        // the resources based on the one changed will be change
        // but only if it is in the same project and the category is still synchronized
<span class="nc" id="L106">        List&lt;ResourceRef&gt; directRefs = resourceDao.findDirectReferences(resourceOrRef);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        for (ResourceRef ref : directRefs) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (ref.getProject() == resourceOrRef.getProject()</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                &amp;&amp; StringUtils.equals(ref.getCategory(), oldCategoryName)) {</span>
<span class="nc" id="L110">                changeCategory(ref.getId(), newCategoryName);</span>
            }

<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">    }</span>

    /**
     * Set the category of a list of resources
     *
     * @param resourceOrRefIds the id of the resources / resource references
     * @param categoryName     the name of the category that apply to the resource / resource
     *                         reference
     */
    public void changeCategory(List&lt;Long&gt; resourceOrRefIds, String categoryName) {
<span class="nc" id="L124">        logger.debug(&quot;set category {} to abstract resources #{}&quot;, categoryName, resourceOrRefIds);</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (resourceOrRefIds == null) {</span>
<span class="nc" id="L127">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

<span class="nc" id="L130">        resourceOrRefIds.stream().forEach(resOrRefId -&gt; changeCategory(resOrRefId, categoryName));</span>
<span class="nc" id="L131">    }</span>

    /**
     * Rename the category in a card type / card type reference
     *
     * @param cardTypeOrRefId the id of the card type / card type reference (scope of the renaming)
     * @param projectId       the id of the project concerned (scope of the renaming)
     * @param oldName         the old name of the category
     * @param newName         the new name of the category
     */
    public void renameCategoryInCardType(Long cardTypeOrRefId, Long projectId, String oldName,
        String newName) {
<span class="nc" id="L143">        logger.debug(&quot;rename category {} to {} in the abstract card type #{}&quot;, oldName, newName,</span>
            cardTypeOrRefId);

<span class="nc" id="L146">        AbstractCardType cardTypeOrRef = cardTypeManager.assertAndGetCardTypeOrRef(cardTypeOrRefId);</span>

<span class="nc" id="L148">        Long effectiveProjectId = projectId;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (projectId == null) {</span>
<span class="nc" id="L150">            effectiveProjectId = cardTypeOrRef.getProjectId();</span>
        }

<span class="nc" id="L153">        renameCategory(cardTypeOrRef, effectiveProjectId, oldName, newName);</span>
<span class="nc" id="L154">    }</span>

    /**
     * Rename the category in a card
     *
     * @param cardId  the id of the card
     * @param oldName the old name of the category
     * @param newName the new name of the category
     */
    public void renameCategoryInCard(Long cardId, String oldName, String newName) {
<span class="nc" id="L164">        logger.debug(&quot;rename category {} to {} in the card #{}&quot;, oldName, newName, cardId);</span>

<span class="nc" id="L166">        Card card = cardManager.assertAndGetCard(cardId);</span>

<span class="nc" id="L168">        renameCategory(card, oldName, newName);</span>
<span class="nc" id="L169">    }</span>

    /**
     * Rename the category in a card content
     *
     * @param cardContentId the id of the card content
     * @param oldName       the old name of the category
     * @param newName       the new name of the category
     */
    public void renameCategoryInCardContent(Long cardContentId, String oldName, String newName) {
<span class="nc" id="L179">        logger.debug(&quot;rename category {} to {} in the card content #{}&quot;, oldName, newName,</span>
            cardContentId);

<span class="nc" id="L182">        CardContent cardContent = cardContentManager.assertAndGetCardContent(cardContentId);</span>

<span class="nc" id="L184">        renameCategory(cardContent, oldName, newName);</span>
<span class="nc" id="L185">    }</span>

    // Note : the sub cards card type / card type reference are not changed. Should they ?

    /**
     * Rename the category in a card type / card type reference&lt;br&gt;
     * And do it also for the implementing cards as long as they are of the same project
     *
     * @param cardTypeOrRef the card type / card type reference (scope of the renaming)
     * @param projectId     the id of the project concerned (scope of the renaming)
     * @param oldName       the old name of the category
     * @param newName       the new name of the category
     */
    private void renameCategory(AbstractCardType cardTypeOrRef,
        Long projectId, String oldName, String newName) {
<span class="nc" id="L200">        cardTypeOrRef.getDirectAbstractResources().stream()</span>
<span class="nc" id="L201">            .forEach(resourceOrRef -&gt; renameCategoryIfMatch(resourceOrRef, oldName, newName));</span>

<span class="nc" id="L203">        cardTypeOrRef.getImplementingCards().stream()</span>
<span class="nc" id="L204">            .filter(card -&gt; Objects.equals(projectId, card.getProject().getId()))</span>
<span class="nc" id="L205">            .forEach(card -&gt; renameCategory(card, oldName, newName));</span>

<span class="nc" id="L207">        cardTypeDao.findDirectReferences(cardTypeOrRef).stream()</span>
<span class="nc" id="L208">            .forEach(cardRef -&gt; renameCategory(cardRef, projectId, oldName, newName));</span>
<span class="nc" id="L209">    }</span>

    /**
     * Rename the category in a card&lt;br&gt;
     * And do it also for each card's variants
     *
     * @param card    the card (scope of the renaming)
     * @param oldName the old name of the category
     * @param newName the new name of the category
     */
    private void renameCategory(Card card, String oldName, String newName) {
<span class="nc" id="L220">        card.getDirectAbstractResources().stream()</span>
<span class="nc" id="L221">            .forEach(resourceOrRef -&gt; renameCategoryIfMatch(resourceOrRef, oldName, newName));</span>

<span class="nc" id="L223">        card.getContentVariants().stream()</span>
<span class="nc" id="L224">            .forEach(cardContent -&gt; renameCategory(cardContent, oldName, newName));</span>
<span class="nc" id="L225">    }</span>

    /**
     * Rename the category in a card content&lt;br&gt;
     * And do it also for each sub cards
     *
     * @param cardContent the card content (scope of the renaming)
     * @param oldName     the old name of the category
     * @param newName     the new name of the category
     */
    private void renameCategory(CardContent cardContent, String oldName, String newName) {
<span class="nc" id="L236">        cardContent.getDirectAbstractResources().stream()</span>
<span class="nc" id="L237">            .forEach(resourceOrRef -&gt; renameCategoryIfMatch(resourceOrRef, oldName, newName));</span>

<span class="nc" id="L239">        cardContent.getSubCards().stream().forEach(card -&gt; renameCategory(card, oldName, newName));</span>
<span class="nc" id="L240">    }</span>

    /**
     * Replace the category of the resource if it matches the oldName
     *
     * @param resourceOrRef the resource or resource reference
     * @param oldName       the old name of the category
     * @param newName       the new name of the category
     */
    private void renameCategoryIfMatch(AbstractResource resourceOrRef, String oldName,
        String newName) {
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (Objects.equals(resourceOrRef.getCategory(), oldName)) {</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            if (StringUtils.isBlank(newName)) {</span>
<span class="nc" id="L253">                resourceOrRef.setCategory(null);</span>
            } else {
<span class="nc" id="L255">                resourceOrRef.setCategory(StringUtils.trim(newName));</span>
            }
        }
<span class="nc" id="L258">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>