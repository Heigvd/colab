<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ResourceCategoryHelper.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-webapp</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.controller.document</a> &gt; <span class="el_source">ResourceCategoryHelper.java</span></div><h1>ResourceCategoryHelper.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021-2023 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.controller.document;

import ch.colabproject.colab.api.controller.RequestManager;
import ch.colabproject.colab.api.controller.card.CardContentManager;
import ch.colabproject.colab.api.controller.card.CardManager;
import ch.colabproject.colab.api.controller.card.CardTypeManager;
import ch.colabproject.colab.api.model.card.AbstractCardType;
import ch.colabproject.colab.api.model.card.Card;
import ch.colabproject.colab.api.model.card.CardContent;
import ch.colabproject.colab.api.model.document.AbstractResource;
import ch.colabproject.colab.api.model.document.ResourceRef;
import ch.colabproject.colab.api.persistence.jpa.card.CardTypeDao;
import ch.colabproject.colab.api.persistence.jpa.document.ResourceDao;
import ch.colabproject.colab.generator.model.exceptions.HttpErrorMessage;
import ch.colabproject.colab.generator.model.exceptions.MessageI18nKey;
import java.util.List;
import java.util.Objects;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.inject.Inject;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Resource and resource reference category specific logic
 *
 * @author sandra
 */
@Stateless
@LocalBean
<span class="nc" id="L38">public class ResourceCategoryHelper {</span>

    /** logger */
<span class="nc" id="L41">    private static final Logger logger = LoggerFactory.getLogger(ResourceCategoryHelper.class);</span>

    // *********************************************************************************************
    // injections

    /**
     * Resource persistence handler
     */
    @Inject
    private ResourceDao resourceDao;

    /**
     * Card type persistence handler
     */
    @Inject
    private CardTypeDao cardTypeDao;

    /**
     * Resource / resource reference related logic
     */
    @Inject
    private ResourceManager resourceManager;

    /**
     * Card type specific logic management
     */
    @Inject
    private CardTypeManager cardTypeManager;

    /**
     * Card specific logic management
     */
    @Inject
    private CardManager cardManager;

    /**
     * Card content specific logic management
     */
    @Inject
    private CardContentManager cardContentManager;
    /**
     * TO sudo
     */
    @Inject
    private RequestManager requestManager;

    // *********************************************************************************************
    // Category management
    // *********************************************************************************************

    /**
     * Set the category of the resource.
     * &lt;p&gt;
     * Also update the resources that reference this one, as long as the category is synchronized
     *
     * @param resourceOrRefId the id of the resource / resource reference
     * @param categoryName    the name of the category that apply to the resource / resource
     *                        reference
     */
    public void changeCategory(Long resourceOrRefId, String categoryName) {
<span class="nc" id="L101">        logger.debug(&quot;set category {} to abstract resource #{}&quot;, categoryName, resourceOrRefId);</span>

<span class="nc" id="L103">        AbstractResource resourceOrRef = resourceManager.assertAndGetResourceOrRef(resourceOrRefId);</span>

<span class="nc" id="L105">        String oldCategoryName = resourceOrRef.getCategory();</span>
<span class="nc" id="L106">        String newCategoryName = StringUtils.trimToNull(categoryName);</span>

<span class="nc" id="L108">        resourceOrRef.setCategory(newCategoryName);</span>

<span class="nc" id="L110">        requestManager.sudo(() -&gt; {</span>
            // also change the resources based on the given one
            // but only if the category is still synchronized
<span class="nc" id="L113">            List&lt;ResourceRef&gt; directRefs = resourceDao.findDirectReferences(resourceOrRef);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">            for (ResourceRef ref : directRefs) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (StringUtils.equals(ref.getCategory(), oldCategoryName)) {</span>
<span class="nc" id="L116">                    changeCategory(ref.getId(), newCategoryName);</span>
                }

<span class="nc" id="L119">            }</span>
<span class="nc" id="L120">        });</span>
<span class="nc" id="L121">    }</span>

    /**
     * Set the category of a list of resources
     *
     * @param resourceOrRefIds the id of the resources / resource references
     * @param categoryName     the name of the category that apply to the resource / resource
     *                         reference
     */
    public void changeCategory(List&lt;Long&gt; resourceOrRefIds, String categoryName) {
<span class="nc" id="L131">        logger.debug(&quot;set category {} to abstract resources #{}&quot;, categoryName, resourceOrRefIds);</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (resourceOrRefIds == null) {</span>
<span class="nc" id="L134">            throw HttpErrorMessage.dataError(MessageI18nKey.DATA_INTEGRITY_FAILURE);</span>
        }

<span class="nc" id="L137">        resourceOrRefIds.stream().forEach(resOrRefId -&gt; changeCategory(resOrRefId, categoryName));</span>
<span class="nc" id="L138">    }</span>

    /**
     * Rename the category in a card type / card type reference
     *
     * @param cardTypeOrRefId the id of the card type / card type reference (scope of the renaming)
     * @param oldName         the old name of the category
     * @param newName         the new name of the category
     */
    public void renameCategoryInCardType(Long cardTypeOrRefId, String oldName,
        String newName) {
<span class="nc" id="L149">        logger.debug(&quot;rename category {} to {} in the abstract card type #{}&quot;, oldName, newName,</span>
            cardTypeOrRefId);

<span class="nc" id="L152">        AbstractCardType cardTypeOrRef = cardTypeManager.assertAndGetCardTypeOrRef(cardTypeOrRefId);</span>

<span class="nc" id="L154">        requestManager.sudo(() -&gt; {</span>
<span class="nc" id="L155">            renameCategory(cardTypeOrRef, oldName, newName);</span>
<span class="nc" id="L156">        });</span>
<span class="nc" id="L157">    }</span>

    /**
     * Rename the category in a card
     *
     * @param cardId  the id of the card
     * @param oldName the old name of the category
     * @param newName the new name of the category
     */
    public void renameCategoryInCard(Long cardId, String oldName, String newName) {
<span class="nc" id="L167">        logger.debug(&quot;rename category {} to {} in the card #{}&quot;, oldName, newName, cardId);</span>

<span class="nc" id="L169">        Card card = cardManager.assertAndGetCard(cardId);</span>

<span class="nc" id="L171">        requestManager.sudo(() -&gt; {</span>
<span class="nc" id="L172">            renameCategory(card, oldName, newName);</span>
<span class="nc" id="L173">        });</span>
<span class="nc" id="L174">    }</span>

    /**
     * Rename the category in a card content
     *
     * @param cardContentId the id of the card content
     * @param oldName       the old name of the category
     * @param newName       the new name of the category
     */
    public void renameCategoryInCardContent(Long cardContentId, String oldName, String newName) {
<span class="nc" id="L184">        logger.debug(&quot;rename category {} to {} in the card content #{}&quot;, oldName, newName,</span>
            cardContentId);

<span class="nc" id="L187">        CardContent cardContent = cardContentManager.assertAndGetCardContent(cardContentId);</span>

<span class="nc" id="L189">        requestManager.sudo(() -&gt; {</span>
<span class="nc" id="L190">            renameCategory(cardContent, oldName, newName);</span>
<span class="nc" id="L191">        });</span>
<span class="nc" id="L192">    }</span>

    /**
     * Rename the category in a card type / card type reference&lt;br&gt;
     * And do it also for the implementing cards and for its reference card types
     *
     * @param cardTypeOrRef the card type / card type reference (scope of the renaming)
     * @param oldName       the old name of the category
     * @param newName       the new name of the category
     */
    private void renameCategory(AbstractCardType cardTypeOrRef,
        String oldName, String newName) {
<span class="nc" id="L204">        cardTypeOrRef.getDirectAbstractResources().stream()</span>
<span class="nc" id="L205">            .forEach(resourceOrRef -&gt; renameCategoryIfMatch(resourceOrRef, oldName, newName));</span>

<span class="nc" id="L207">        cardTypeOrRef.getImplementingCards().stream()</span>
<span class="nc" id="L208">            .forEach(card -&gt; renameCategory(card, oldName, newName));</span>

<span class="nc" id="L210">        cardTypeDao.findDirectReferences(cardTypeOrRef).stream()</span>
<span class="nc" id="L211">            .forEach(cardRef -&gt; renameCategory(cardRef, oldName, newName));</span>
<span class="nc" id="L212">    }</span>

    /**
     * Rename the category in a card&lt;br&gt;
     * And do it also for each card's variants
     *
     * @param card    the card (scope of the renaming)
     * @param oldName the old name of the category
     * @param newName the new name of the category
     */
    private void renameCategory(Card card, String oldName, String newName) {
<span class="nc" id="L223">        card.getDirectAbstractResources().stream()</span>
<span class="nc" id="L224">            .forEach(resourceOrRef -&gt; renameCategoryIfMatch(resourceOrRef, oldName, newName));</span>

<span class="nc" id="L226">        card.getContentVariants().stream()</span>
<span class="nc" id="L227">            .forEach(cardContent -&gt; renameCategory(cardContent, oldName, newName));</span>
<span class="nc" id="L228">    }</span>

    /**
     * Rename the category in a card content&lt;br&gt;
     * And do it also for each sub cards
     *
     * @param cardContent the card content (scope of the renaming)
     * @param oldName     the old name of the category
     * @param newName     the new name of the category
     */
    private void renameCategory(CardContent cardContent, String oldName, String newName) {
<span class="nc" id="L239">        cardContent.getDirectAbstractResources().stream()</span>
<span class="nc" id="L240">            .forEach(resourceOrRef -&gt; renameCategoryIfMatch(resourceOrRef, oldName, newName));</span>

<span class="nc" id="L242">        cardContent.getSubCards().stream().forEach(card -&gt; renameCategory(card, oldName, newName));</span>
<span class="nc" id="L243">    }</span>

    /**
     * Replace the category of the resource if it matches the oldName
     *
     * @param resourceOrRef the resource or resource reference
     * @param oldName       the old name of the category
     * @param newName       the new name of the category
     */
    private void renameCategoryIfMatch(AbstractResource resourceOrRef, String oldName,
        String newName) {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (Objects.equals(</span>
<span class="nc" id="L255">            StringUtils.trimToNull(resourceOrRef.getCategory()),</span>
<span class="nc" id="L256">            StringUtils.trimToNull(oldName))) {</span>
<span class="nc" id="L257">            resourceOrRef.setCategory(StringUtils.trimToNull(newName));</span>
        }
<span class="nc" id="L259">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>