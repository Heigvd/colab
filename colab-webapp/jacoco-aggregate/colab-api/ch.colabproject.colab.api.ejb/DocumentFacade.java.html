<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DocumentFacade.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">colab-webapp</a> &gt; <a href="../index.html" class="el_bundle">colab-api</a> &gt; <a href="index.source.html" class="el_package">ch.colabproject.colab.api.ejb</a> &gt; <span class="el_source">DocumentFacade.java</span></div><h1>DocumentFacade.java</h1><pre class="source lang-java linenums">/*
 * The coLAB project
 * Copyright (C) 2021 AlbaSim, MEI, HEIG-VD, HES-SO
 *
 * Licensed under the MIT License
 */
package ch.colabproject.colab.api.ejb;

import ch.colabproject.colab.api.controller.card.CardContentManager;
import ch.colabproject.colab.api.model.card.CardContent;
import ch.colabproject.colab.api.model.document.Block;
import ch.colabproject.colab.api.model.document.BlockDocument;
import ch.colabproject.colab.api.model.document.Document;
import ch.colabproject.colab.api.persistence.document.DocumentDao;
import ch.colabproject.colab.generator.model.exceptions.HttpErrorMessage;
import java.util.List;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.inject.Inject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Document specific logic
 *
 * @author sandra
 */
@Stateless
@LocalBean
<span class="nc" id="L30">public class DocumentFacade {</span>

    /** logger */
<span class="nc" id="L33">    private static final Logger logger = LoggerFactory.getLogger(DocumentFacade.class);</span>

    // *********************************************************************************************
    // injections
    // *********************************************************************************************

    /**
     * Document persistence handler
     */
    @Inject
    private DocumentDao documentDao;

    /**
     * Card content specific logic management
     */
    @Inject
    private CardContentManager cardContentManager;

    // *********************************************************************************************
    // find document
    // *********************************************************************************************

    /**
     * Retrieve the document. If not found, throw a {@link HttpErrorMessage}.
     *
     * @param documentId the id of the document
     *
     * @return the document if found
     *
     * @throws HttpErrorMessage if the document was not found
     */
    public Document assertAndGetDocument(Long documentId) {
<span class="nc" id="L65">        Document document = documentDao.findDocument(documentId);</span>

<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (document == null) {</span>
<span class="nc" id="L68">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

<span class="nc" id="L71">        return document;</span>
    }

    /**
     * Retrieve the block document. If not found, throw a {@link HttpErrorMessage}.
     *
     * @param documentId the id of the block document
     *
     * @return the block document if found
     *
     * @throws HttpErrorMessage if the block document was not found
     */
    public BlockDocument assertAndGetBlockDocument(Long documentId) {
<span class="nc" id="L84">        Document document = documentDao.findDocument(documentId);</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!(document instanceof BlockDocument)) {</span>
<span class="nc" id="L87">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }

<span class="nc" id="L90">        return (BlockDocument) document;</span>
    }

    /**
     * Assert that the block document is not null. If not throw a {@link HttpErrorMessage}.
     *
     * @param blockDocument the block document to check
     *
     * @throws HttpErrorMessage if the block document is null
     */
    public void assertBlockDocument(BlockDocument blockDocument) {
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (blockDocument == null) {</span>
<span class="nc" id="L102">            throw HttpErrorMessage.relatedObjectNotFoundError();</span>
        }
<span class="nc" id="L104">    }</span>

    // *********************************************************************************************
    // life cycle
    // *********************************************************************************************

    /**
     * Complete and persist the given new document
     *
     * @param document the document to persist
     *
     * @return the new persisted document
     */
    // TODO no effective use. To destroy during RestEndpoint cleaning
    public Document createDocument(Document document) {
<span class="nc" id="L119">        logger.debug(&quot;create document : {}&quot;, document);</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (document.getDeliverableCardContentId() != null) {</span>
<span class="nc" id="L122">            CardContent cardContent = cardContentManager</span>
<span class="nc" id="L123">                .assertAndGetCardContent(document.getDeliverableCardContentId());</span>

<span class="nc" id="L125">            cardContent.setDeliverable(document);</span>
<span class="nc" id="L126">            document.setDeliverableCardContent(cardContent);</span>
        }

<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (document.getResourceId() != null) {</span>
<span class="nc" id="L130">            throw HttpErrorMessage.dataIntegrityFailure();</span>
        }

<span class="nc" id="L133">        return documentDao.persistDocument(document);</span>
    }

    /**
     * Delete the given document
     *
     * @param documentId the id of the document to delete
     *
     * @return the freshly deleted document
     */
    // TODO no effective use. To destroy during RestEndpoint cleaning
    public Document deleteDocument(Long documentId) {
<span class="nc" id="L145">        logger.debug(&quot;delete document #{}&quot;, documentId);</span>

<span class="nc" id="L147">        Document document = assertAndGetDocument(documentId);</span>

<span class="nc" id="L149">        CardContent cardContent = document.getDeliverableCardContent();</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (cardContent != null) {</span>
<span class="nc" id="L151">            cardContent.setDeliverable(null);</span>
        }

        // to check : resource handling

<span class="nc" id="L156">        return documentDao.deleteDocument(documentId);</span>
    }

    // *********************************************************************************************
    // block documents
    // *********************************************************************************************

    /**
     * Get all blocks that make up the document
     *
     * @param documentId the id of the document
     *
     * @return all blocks of the document
     */
    // TODO To move into BlockFacade during RestEndpoint cleaning
    public List&lt;Block&gt; getBlocksOfDocument(Long documentId) {
<span class="nc" id="L172">        logger.debug(&quot;get blocks composing the document #{}&quot;, documentId);</span>

<span class="nc" id="L174">        BlockDocument document = assertAndGetBlockDocument(documentId);</span>

<span class="nc" id="L176">        return document.getBlocks();</span>
    }

    // *********************************************************************************************
    // integrity check
    // *********************************************************************************************

    /**
     * Check the integrity of the document
     *
     * @param document the document to check
     *
     * @return true iff the document is complete and safe
     */
    public boolean checkIntegrity(Document document) {
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (document == null) {</span>
<span class="nc" id="L192">            return false;</span>
        }

<span class="nc bnc" id="L195" title="All 4 branches missed.">        if (!(document.hasDeliverableCardContent() || document.hasResource())) {</span>
<span class="nc" id="L196">            return false;</span>
        }

<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (document instanceof BlockDocument) {</span>
<span class="nc" id="L200">            return checkBlockDocumentSpecificIntegrity((BlockDocument)document);</span>
        } else {
<span class="nc" id="L202">            return true;</span>
        }
    }

    private boolean checkBlockDocumentSpecificIntegrity(BlockDocument document) {
        // not twice the same index
//        List&lt;Block&gt; blocks = document.getBlocks();
//        if (!CollectionUtils.isEmpty(blocks)) {
            // TODO
//        }
        // TODO delete that. It is just to satisfy PMD
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (document == null) {</span>
<span class="nc" id="L214">            return false;</span>
        }

<span class="nc" id="L217">        return true;</span>
    }

    // *********************************************************************************************
    //
    // *********************************************************************************************

    // As a document is either linked to a resource or to a card content, most of the operations are
    // made from there

    // *********************************************************************************************
    //
    // *********************************************************************************************

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>